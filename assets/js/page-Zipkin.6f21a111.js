(window.webpackJsonp=window.webpackJsonp||[]).push([[102],{1112:function(e,t,a){"use strict";a.r(t);var s=a(1),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h2",{attrs:{id:"目录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#目录"}},[e._v("#")]),e._v(" 目录")]),e._v(" "),a("ul",[a("li",[a("RouterLink",{attrs:{to:"/spring/track/zipkin/info.html"}},[e._v("介绍")])],1),e._v(" "),a("li",[a("RouterLink",{attrs:{to:"/spring/track/zipkin/quick-start.html"}},[e._v("快速入门")])],1),e._v(" "),a("li",[a("RouterLink",{attrs:{to:"/spring/track/zipkin/start-env.html"}},[e._v("zipkin启动及环境配置")])],1),e._v(" "),a("li",[a("RouterLink",{attrs:{to:"/spring/track/zipkin/demo.html"}},[e._v("生产案例")])],1)])])}),[],!1,null,null,null);t.default=r.exports},1114:function(e,t,a){"use strict";a.r(t);var s=a(1),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"zipkin-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zipkin-server"}},[e._v("#")]),e._v(" zipkin-server")]),e._v(" "),a("p",[e._v("Zipkin Server is a Java 1.8+ service, packaged as an executable jar.")]),e._v(" "),a("p",[e._v("Span storage and collectors are "),a("a",{attrs:{href:"#configuration"}},[e._v("configurable")]),e._v(". By default, storage is in-memory,\nthe HTTP collector (POST /api/v2/spans endpoint) is enabled, and the server listens on port 9411.")]),e._v(" "),a("p",[e._v("Zipkin Server is implemented with "),a("a",{attrs:{href:"https://github.com/line/armeria",target:"_blank",rel:"noopener noreferrer"}},[e._v("Armeria"),a("OutboundLink")],1),e._v(". While it uses "),a("a",{attrs:{href:"http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring Boot"),a("OutboundLink")],1),e._v("\ninternally, Zipkin Server should not be considered a normal Spring Boot application.")]),e._v(" "),a("h2",{attrs:{id:"custom-servers-are-not-supported"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#custom-servers-are-not-supported"}},[e._v("#")]),e._v(" Custom servers are not supported")]),e._v(" "),a("p",[e._v("By Custom servers we mean trying to use/embed "),a("code",[e._v("zipkin")]),e._v(" as part of "),a("em",[e._v("an application you package")]),e._v(" (e.g. adding "),a("code",[e._v("zipkin-server")]),e._v(" dependency to a Spring-boot application) instead of the packaged application we release.")]),e._v(" "),a("p",[e._v("For proper usage, see the guides below.")]),e._v(" "),a("h2",{attrs:{id:"quick-start"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#quick-start"}},[e._v("#")]),e._v(" Quick-start")]),e._v(" "),a("p",[e._v("The quickest way to get started is to fetch the "),a("a",{attrs:{href:"https://search.maven.org/remote_content?g=io.zipkin&a=zipkin-server&v=LATEST&c=exec",target:"_blank",rel:"noopener noreferrer"}},[e._v("latest released server"),a("OutboundLink")],1),e._v(" as a self-contained executable jar. Note that the Zipkin server requires minimum JRE 8. For example:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" -sSL https://zipkin.io/quickstart.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("bash")]),e._v(" -s\n$ java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("Once you've started, browse to http://your_host:9411 to find traces!")]),e._v(" "),a("h2",{attrs:{id:"endpoints"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#endpoints"}},[e._v("#")]),e._v(" Endpoints")]),e._v(" "),a("p",[e._v("The following endpoints are defined under the base url http://your_host:9411")]),e._v(" "),a("ul",[a("li",[e._v("/ - "),a("a",{attrs:{href:"../zipkin-ui"}},[e._v("UI")])]),e._v(" "),a("li",[e._v("/config.json - "),a("a",{attrs:{href:"#configuration-for-the-ui"}},[e._v("Configuration for the UI")])]),e._v(" "),a("li",[e._v("/api/v2 - "),a("a",{attrs:{href:"https://zipkin.io/zipkin-api/#/",target:"_blank",rel:"noopener noreferrer"}},[e._v("API"),a("OutboundLink")],1)]),e._v(" "),a("li",[e._v("/health - Returns 200 status if OK")]),e._v(" "),a("li",[e._v("/info - Provides the version of the running instance")]),e._v(" "),a("li",[e._v("/metrics - Includes collector metrics broken down by transport type")]),e._v(" "),a("li",[e._v("/prometheus - Prometheus scrape endpoint")])]),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"https://zipkin.io/zipkin-api/#/",target:"_blank",rel:"noopener noreferrer"}},[e._v("legacy /api/v1 API"),a("OutboundLink")],1),e._v(" is still supported. Backends are decoupled from the\nHTTP API via data conversion. This means you can still accept legacy data on new backends and visa versa. Enter\n"),a("code",[e._v("https://zipkin.io/zipkin-api/zipkin-api.yaml")]),e._v(" into the explore box of the Swagger UI to view the old definition")]),e._v(" "),a("h3",{attrs:{id:"cors-cross-origin-resource-sharing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cors-cross-origin-resource-sharing"}},[e._v("#")]),e._v(" CORS (Cross-origin Resource Sharing)")]),e._v(" "),a("p",[e._v("By default, all endpoints under "),a("code",[e._v("/api/v2")]),e._v(" are configured to "),a("strong",[e._v("allow")]),e._v(" cross-origin requests.")]),e._v(" "),a("p",[e._v("This can be changed by modifying the property "),a("code",[e._v("zipkin.query.allowed-origins")]),e._v(".")]),e._v(" "),a("p",[e._v("For example, to allow CORS requests from "),a("code",[e._v("http://foo.bar.com")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("ZIPKIN_QUERY_ALLOWED_ORIGINS=http://foo.bar.com\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("See "),a("a",{attrs:{href:"#configuration"}},[e._v("Configuration")]),e._v(" for more about how Zipkin is configured.")]),e._v(" "),a("h3",{attrs:{id:"service-and-span-names-query"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#service-and-span-names-query"}},[e._v("#")]),e._v(" Service and Span names query")]),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"https://zipkin.io/zipkin-api/#/default/get_services",target:"_blank",rel:"noopener noreferrer"}},[e._v("Zipkin API"),a("OutboundLink")],1),e._v(" does not include\na parameter for how far back to look for service or span names. In order\nto prevent excessive load, service and span name queries are limited by\n"),a("code",[e._v("QUERY_LOOKBACK")]),e._v(", which defaults to 24hrs (two daily buckets: one for\ntoday and one for yesterday)")]),e._v(" "),a("h2",{attrs:{id:"logging"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#logging"}},[e._v("#")]),e._v(" Logging")]),e._v(" "),a("p",[e._v("By default, zipkin writes log messages to the console at INFO level and above. You can adjust\ncategories using the "),a("code",[e._v("logging.level.XXX")]),e._v(" property.")]),e._v(" "),a("p",[e._v("For example, if you want to enable debug logging for all zipkin categories, you can start the server like so:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ java -jar zipkin.jar --logging.level.zipkin2"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("DEBUG\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("See "),a("a",{attrs:{href:"#configuration"}},[e._v("Configuration")]),e._v(" for more about how Zipkin is configured.")]),e._v(" "),a("h3",{attrs:{id:"advanced-logging-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#advanced-logging-configuration"}},[e._v("#")]),e._v(" Advanced Logging Configuration")]),e._v(" "),a("p",[e._v("Under the covers, the server uses "),a("a",{attrs:{href:"http://docs.spring.io/spring-boot/docs/current/reference/html/howto-logging.html#howto-configure-logback-for-logging",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring Boot - Logback integration"),a("OutboundLink")],1),e._v(".\nFor example, you can add "),a("code",[e._v("--logging.exception-conversion-word=%wEx{full}")]),e._v(" to dump full stack traces\ninstead of truncated ones.")]),e._v(" "),a("h2",{attrs:{id:"metrics"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#metrics"}},[e._v("#")]),e._v(" Metrics")]),e._v(" "),a("p",[e._v("Collector Metrics are exported to the path "),a("code",[e._v("/metrics")]),e._v(". These and additional metrics are exported\nto the path "),a("code",[e._v("/prometheus")]),e._v(".")]),e._v(" "),a("h3",{attrs:{id:"example-prometheus-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#example-prometheus-configuration"}},[e._v("#")]),e._v(" Example Prometheus configuration")]),e._v(" "),a("p",[e._v("Here's an example "),a("code",[e._v("/prometheus")]),e._v(" configuration, using the Prometheus\nexposition "),a("a",{attrs:{href:"https://prometheus.io/docs/instrumenting/exposition_formats/",target:"_blank",rel:"noopener noreferrer"}},[e._v("text format version 0.0.4"),a("OutboundLink")],1)]),e._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[e._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("job_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'zipkin'")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("scrape_interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 5s\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("metrics_path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'/prometheus'")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("static_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("targets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'localhost:9411'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("metric_relabel_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Response code count")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("__name__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'^status_(\\d+)_(.*)$'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'${1}'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" status\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("__name__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'^status_(\\d+)_(.*)$'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'${2}'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" path\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("__name__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'^status_(\\d+)_(.*)$'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'http_requests_total'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" __name__\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br"),a("span",{staticClass:"line-number"},[e._v("17")]),a("br"),a("span",{staticClass:"line-number"},[e._v("18")]),a("br"),a("span",{staticClass:"line-number"},[e._v("19")]),a("br")])]),a("h3",{attrs:{id:"collector"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#collector"}},[e._v("#")]),e._v(" Collector")]),e._v(" "),a("p",[e._v('Collector metrics are broken down by transport. The following are exported to the "/metrics" endpoint:')]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Metric")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("counter.zipkin_collector.messages.$transport")]),e._v(" "),a("td",[e._v("cumulative messages received; should relate to messages reported by instrumented apps")])]),e._v(" "),a("tr",[a("td",[e._v("counter.zipkin_collector.messages_dropped.$transport")]),e._v(" "),a("td",[e._v("cumulative messages dropped; reasons include client disconnects or malformed content")])]),e._v(" "),a("tr",[a("td",[e._v("counter.zipkin_collector.bytes.$transport")]),e._v(" "),a("td",[e._v("cumulative message bytes")])]),e._v(" "),a("tr",[a("td",[e._v("counter.zipkin_collector.spans.$transport")]),e._v(" "),a("td",[e._v("cumulative spans read; should relate to messages reported by instrumented apps")])]),e._v(" "),a("tr",[a("td",[e._v("counter.zipkin_collector.spans_dropped.$transport")]),e._v(" "),a("td",[e._v("cumulative spans dropped; reasons include sampling or storage failures")])]),e._v(" "),a("tr",[a("td",[e._v("gauge.zipkin_collector.message_spans.$transport")]),e._v(" "),a("td",[e._v("last count of spans in a message")])]),e._v(" "),a("tr",[a("td",[e._v("gauge.zipkin_collector.message_bytes.$transport")]),e._v(" "),a("td",[e._v("last count of bytes in a message")])])])]),e._v(" "),a("h2",{attrs:{id:"configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configuration"}},[e._v("#")]),e._v(" Configuration")]),e._v(" "),a("p",[e._v("We support ENV variable configuration, such as "),a("code",[e._v("STORAGE_TYPE=cassandra3")]),e._v(", as they are familiar to\nadministrators and easy to use in runtime environments such as Docker.")]),e._v(" "),a("p",[e._v("Here are the top-level configuration of Zipkin:")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("QUERY_PORT")]),e._v(": Listen port for the HTTP API and web UI; Defaults to 9411")]),e._v(" "),a("li",[a("code",[e._v("QUERY_ENABLED")]),e._v(": "),a("code",[e._v("false")]),e._v(" disables the HTTP read endpoints under '/api/v2'. This also disables the\nUI, as it relies on the API. If your only goal is to restrict search, use "),a("code",[e._v("SEARCH_ENABLED")]),e._v(" instead.\nDefaults to true")]),e._v(" "),a("li",[a("code",[e._v("SEARCH_ENABLED")]),e._v(": "),a("code",[e._v("false")]),e._v(" disables searching in the query API and any indexing or post-processing\nin the collector to support search. This does not disable the entire UI, as trace by ID and\ndependency queries still operate. Disable this when you use another service (such as logs) to find\ntrace IDs. Defaults to true")]),e._v(" "),a("li",[a("code",[e._v("QUERY_TIMEOUT")]),e._v(": Sets the hard timeout for query requests. Accepts any duration string (e.g., 100ms).\nA value of 0 will disable the timeout completely. Defaults to 11s.")]),e._v(" "),a("li",[a("code",[e._v("QUERY_LOG_LEVEL")]),e._v(": Log level written to the console; Defaults to INFO")]),e._v(" "),a("li",[a("code",[e._v("QUERY_NAMES_MAX_AGE")]),e._v(": Controls the value of the "),a("code",[e._v("max-age")]),e._v(" header zipkin-server responds with on\nhttp requests for autocompleted values in the UI (service names for example). Defaults to 300 seconds.")]),e._v(" "),a("li",[a("code",[e._v("QUERY_LOOKBACK")]),e._v(": How many milliseconds queries can look back from endTs; Defaults to 24 hours (two daily buckets: one for today and one for yesterday)")]),e._v(" "),a("li",[a("code",[e._v("STORAGE_TYPE")]),e._v(": SpanStore implementation: one of "),a("code",[e._v("mem")]),e._v(", "),a("code",[e._v("mysql")]),e._v(", "),a("code",[e._v("cassandra3")]),e._v(", "),a("code",[e._v("elasticsearch")])]),e._v(" "),a("li",[a("code",[e._v("COLLECTOR_SAMPLE_RATE")]),e._v(": Percentage of traces to retain, defaults to always sample (1.0).")]),e._v(" "),a("li",[a("code",[e._v("AUTOCOMPLETE_KEYS")]),e._v(": list of span tag keys which will be returned by the "),a("code",[e._v("/api/v2/autocompleteTags")]),e._v(' endpoint; Tag keys should be comma separated e.g. "instance_id,user_id,env"')]),e._v(" "),a("li",[a("code",[e._v("AUTOCOMPLETE_TTL")]),e._v(": How long in milliseconds to suppress calls to write the same autocomplete key/value pair. Default 3600000 (1 hr)")])]),e._v(" "),a("h3",{attrs:{id:"configuration-file-overrides"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configuration-file-overrides"}},[e._v("#")]),e._v(" Configuration file overrides")]),e._v(" "),a("p",[e._v("Under the scenes, all configuration are managed by Spring Boot. This means that properties may also\nbe overridden by system properties or any other alternative "),a("a",{attrs:{href:"https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("supported by Spring Boot"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v("We use "),a("a",{attrs:{href:"src/main/resources/zipkin-server-shared.yml"}},[e._v("yaml configuration")]),e._v(" to bind shorter or more\nidiomatic ENV variables to the Spring properties ultimately in use. While most users should only use\nenvironment variables, some may desire a properties file approach to override settings. For example,\nknowing we set "),a("code",[e._v("spring.config.name=zipkin-server")]),e._v(", Spring Boot will automatically look for a file\nnamed "),a("code",[e._v("zipkin-server.properties")]),e._v(" in the current directory, and the same properties we set in yaml\ncan be overridden that way.")]),e._v(" "),a("p",[e._v("If you choose to use property-based configuration instead of ENV variables, you are choosing to\nself-support your configuration. This means you'll use "),a("a",{attrs:{href:"https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring Boot documentation"),a("OutboundLink")],1),e._v("\nor "),a("a",{attrs:{href:"https://stackoverflow.com/questions/tagged/spring-boot",target:"_blank",rel:"noopener noreferrer"}},[e._v("StackOverflow"),a("OutboundLink")],1),e._v(" to resolve concerns\nrelated to property resolution as opposed to raising issues or using our chat support. We have to\nmention this because configuration of Spring implies vast responsibility and our resources must be\nconserved for Zipkin related tasks.")]),e._v(" "),a("h2",{attrs:{id:"ui"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ui"}},[e._v("#")]),e._v(" UI")]),e._v(" "),a("p",[e._v("Zipkin has a web UI, automatically included in the exec jar, and is hosted by default on port 9411.")]),e._v(" "),a("p",[e._v("When the UI loads, it reads default configuration from the "),a("code",[e._v("/config.json")]),e._v(" endpoint.")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Attribute")]),e._v(" "),a("th",[e._v("Property")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("environment")]),e._v(" "),a("td",[e._v("zipkin.ui.environment")]),e._v(" "),a("td",[e._v("The value here becomes a label in the top-right corner. Not required.")])]),e._v(" "),a("tr",[a("td",[e._v("defaultLookback")]),e._v(" "),a("td",[e._v("zipkin.ui.default-lookback")]),e._v(" "),a("td",[e._v('Default duration in millis to look back when finding traces. Affects the "Start time" element in the UI. Defaults to 900000 (15 minutes in millis).')])]),e._v(" "),a("tr",[a("td",[e._v("searchEnabled")]),e._v(" "),a("td",[e._v("zipkin.ui.search-enabled")]),e._v(" "),a("td",[e._v("If the Discover screen is enabled. Defaults to true.")])]),e._v(" "),a("tr",[a("td",[e._v("queryLimit")]),e._v(" "),a("td",[e._v("zipkin.ui.query-limit")]),e._v(" "),a("td",[e._v("Default limit for Find Traces. Defaults to 10.")])]),e._v(" "),a("tr",[a("td",[e._v("instrumented")]),e._v(" "),a("td",[e._v("zipkin.ui.instrumented")]),e._v(" "),a("td",[e._v("Which sites this Zipkin UI covers. Regex syntax. e.g. "),a("code",[e._v("http:\\/\\/example.com\\/.*")]),e._v(" Defaults to match all websites ("),a("code",[e._v(".*")]),e._v(").")])]),e._v(" "),a("tr",[a("td",[e._v("logsUrl")]),e._v(" "),a("td",[e._v("zipkin.ui.logs-url")]),e._v(" "),a("td",[e._v("Logs query service url pattern. If specified, a button will appear on the trace page and will replace {traceId} in the url by the traceId. Not required.")])]),e._v(" "),a("tr",[a("td",[e._v("supportUrl")]),e._v(" "),a("td",[e._v("zipkin.ui.support-url")]),e._v(" "),a("td",[e._v("A URL where a user can ask for support. If specified, a link will be placed in the side menu to this URL, for example a page to file support tickets. Not required.")])]),e._v(" "),a("tr",[a("td",[e._v("archivePostUrl")]),e._v(" "),a("td",[e._v("zipkin.ui.archive-post-url")]),e._v(" "),a("td",[e._v("Url to POST the current trace in Zipkin v2 json format. e.g. 'https://longterm/api/v2/spans'. If specified, a button will appear on the trace page accordingly. Not required.")])]),e._v(" "),a("tr",[a("td",[e._v("archiveUrl")]),e._v(" "),a("td",[e._v("zipkin.ui.archive-url")]),e._v(" "),a("td",[e._v("Url to a web application serving an archived trace, templated by '{traceId}'. e.g. https://longterm/zipkin/trace/{traceId}'. This is shown in a confirmation message after a trace is successfully POSTed to the "),a("code",[e._v("archivePostUrl")]),e._v(". Not required.")])]),e._v(" "),a("tr",[a("td",[e._v("dependency.enabled")]),e._v(" "),a("td",[e._v("zipkin.ui.dependency.enabled")]),e._v(" "),a("td",[e._v("If the Dependencies screen is enabled. Defaults to true.")])]),e._v(" "),a("tr",[a("td",[e._v("dependency.lowErrorRate")]),e._v(" "),a("td",[e._v("zipkin.ui.dependency.low-error-rate")]),e._v(" "),a("td",[e._v("The rate of error calls on a dependency link that turns it yellow. Defaults to 0.5 (50%) set to >1 to disable.")])]),e._v(" "),a("tr",[a("td",[e._v("dependency.highErrorRate")]),e._v(" "),a("td",[e._v("zipkin.ui.dependency.high-error-rate")]),e._v(" "),a("td",[e._v("The rate of error calls on a dependency link that turns it red. Defaults to 0.75 (75%) set to >1 to disable.")])]),e._v(" "),a("tr",[a("td",[e._v("basePath")]),e._v(" "),a("td",[e._v("zipkin.ui.basepath")]),e._v(" "),a("td",[e._v("path prefix placed into the "),a("base"),e._v(' tag in the UI HTML; useful when running behind a reverse proxy. Default "/zipkin"')])])])]),e._v(" "),a("p",[e._v("To map properties to environment variables, change them to upper-underscore case format. For\nexample, if using docker you can set "),a("code",[e._v("ZIPKIN_UI_QUERY_LIMIT=100")]),e._v(" to affect "),a("code",[e._v("$.queryLimit")]),e._v(" in "),a("code",[e._v("/config.json")]),e._v(".")]),e._v(" "),a("h3",{attrs:{id:"trace-archival"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#trace-archival"}},[e._v("#")]),e._v(" Trace archival")]),e._v(" "),a("p",[e._v("Most production Zipkin clusters store traces with a limited TTL. This makes it a bit inconvenient to\nshare a trace, as the link to it will expire after a few days.")]),e._v(" "),a("p",[e._v('The "archive a trace" feature helps with this. Launch a second zipkin server pointing to a storage with a longer\nTTL than the regular one and set the archivePostUrl and archiveUrl UI configs pointing to this second server.\nOnce archivePostUrl is set, a new "Archive Trace" button will appear on the trace view page.')]),e._v(" "),a("h2",{attrs:{id:"storage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#storage"}},[e._v("#")]),e._v(" Storage")]),e._v(" "),a("h3",{attrs:{id:"in-memory-storage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#in-memory-storage"}},[e._v("#")]),e._v(" In-Memory Storage")]),e._v(" "),a("p",[e._v("Zipkin's "),a("a",{attrs:{href:"../zipkin/src/main/java/zipkin2/storage/InMemoryStorage.java"}},[e._v("In-Memory Storage")]),e._v(" holds all\ndata in memory, purging older data upon a span limit. It applies when "),a("code",[e._v("STORAGE_TYPE")]),e._v(" is unset or\nset to the value "),a("code",[e._v("mem")]),e._v(".")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("* `MEM_MAX_SPANS`: Oldest traces (and their spans) will be purged first when this limit is exceeded. Default 500000\n")])])]),a("p",[e._v("Example usage:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("Note: this storage component was primarily developed for testing and as a means to get Zipkin server\nup and running quickly without external dependencies. It is not viable for high work loads. That\nsaid, if you encounter out-of-memory errors, try decreasing "),a("code",[e._v("MEM_MAX_SPANS")]),e._v(" or increasing the heap\nsize (-Xmx).")]),e._v(" "),a("p",[e._v("Exampled of doubling the amount of spans held in memory:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("MEM_MAX_SPANS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1000000")]),e._v(" java -Xmx1G -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h3",{attrs:{id:"cassandra-storage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cassandra-storage"}},[e._v("#")]),e._v(" Cassandra Storage")]),e._v(" "),a("p",[e._v("Zipkin's "),a("a",{attrs:{href:"../zipkin-storage/cassandra"}},[e._v("Cassandra storage component")]),e._v(" supports Cassandra 3.11.3+\nand applies when "),a("code",[e._v("STORAGE_TYPE")]),e._v(" is set to "),a("code",[e._v("cassandra3")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v('* `CASSANDRA_KEYSPACE`: The keyspace to use. Defaults to "zipkin2"\n* `CASSANDRA_CONTACT_POINTS`: Comma separated list of host addresses part of Cassandra cluster. You can also specify a custom port with \'host:port\'. Defaults to localhost on port 9042.\n* `CASSANDRA_LOCAL_DC`: Name of the datacenter that will be considered "local" for load balancing. Defaults to "datacenter1"\n* `CASSANDRA_ENSURE_SCHEMA`: Ensuring cassandra has the latest schema. If enabled tries to execute scripts in the classpath prefixed with `cassandra-schema-cql3`. Defaults to true\n* `CASSANDRA_USERNAME` and `CASSANDRA_PASSWORD`: Cassandra authentication. Will throw an exception on startup if authentication fails. No default\n* `CASSANDRA_USE_SSL`: Requires `javax.net.ssl.trustStore` and `javax.net.ssl.trustStorePassword`, defaults to false.\n')])])]),a("p",[e._v("The following are tuning parameters which may not concern all users:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("* `CASSANDRA_MAX_CONNECTIONS`: Max pooled connections per datacenter-local host. Defaults to 8\n* `CASSANDRA_INDEX_CACHE_MAX`: Maximum trace index metadata entries to cache. Zero disables caching. Defaults to 100000.\n* `CASSANDRA_INDEX_CACHE_TTL`: How many seconds to cache index metadata about a trace. Defaults to 60.\n* `CASSANDRA_INDEX_FETCH_MULTIPLIER`: How many more index rows to fetch than the user-supplied query limit. Defaults to 3.\n")])])]),a("p",[e._v("Example usage with Cassandra with request logging (TRACE shows query values):")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("STORAGE_TYPE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("cassandra3 java -jar zipkin.jar "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--logging.level.com.datastax.oss.driver.internal.core.tracker.RequestLogger"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("DEBUG\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("h3",{attrs:{id:"elasticsearch-storage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch-storage"}},[e._v("#")]),e._v(" Elasticsearch Storage")]),e._v(" "),a("p",[e._v("Zipkin's "),a("a",{attrs:{href:"../zipkin-storage/elasticsearch"}},[e._v("Elasticsearch storage component")]),e._v("\nsupports versions 5-7.x and applies when "),a("code",[e._v("STORAGE_TYPE")]),e._v(" is set to "),a("code",[e._v("elasticsearch")])]),e._v(" "),a("p",[e._v("The following apply when "),a("code",[e._v("STORAGE_TYPE")]),e._v(" is set to "),a("code",[e._v("elasticsearch")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("* `ES_HOSTS`: A comma separated list of elasticsearch base urls to connect to ex. http://host:9200.\n              Defaults to \"http://localhost:9200\".\n* `ES_PIPELINE`: Indicates the ingest pipeline used before spans are indexed. No default.\n* `ES_TIMEOUT`: Controls the connect, read and write socket timeouts (in milliseconds) for\n                Elasticsearch API. Defaults to 10000 (10 seconds)\n* `ES_INDEX`: The index prefix to use when generating daily index names. Defaults to zipkin.\n* `ES_DATE_SEPARATOR`: The date separator to use when generating daily index names. Defaults to '-'.\n* `ES_INDEX_SHARDS`: The number of shards to split the index into. Each shard and its replicas\n                     are assigned to a machine in the cluster. Increasing the number of shards\n                     and machines in the cluster will improve read and write performance. Number\n                     of shards cannot be changed for existing indices, but new daily indices\n                     will pick up changes to the setting. Defaults to 5.\n* `ES_INDEX_REPLICAS`: The number of replica copies of each shard in the index. Each shard and\n                       its replicas are assigned to a machine in the cluster. Increasing the\n                       number of replicas and machines in the cluster will improve read\n                       performance, but not write performance. Number of replicas can be changed\n                       for existing indices. Defaults to 1. It is highly discouraged to set this\n                       to 0 as it would mean a machine failure results in data loss.\n* `ES_ENSURE_TEMPLATES`: Installs Zipkin index templates when missing. Setting this to false can\n                         lead to corrupted data when index templates mismatch expectations. If\n                         you set this to false, you choose to troubleshoot your own data or\n                         migration problems as opposed to relying on the community for this.\n                         Defaults to true.\n* `ES_USERNAME` and `ES_PASSWORD`: Elasticsearch basic authentication, which defaults to empty string.\n                                   Use when X-Pack security (formerly Shield) is in place.\n* `ES_CREDENTIALS_FILE`: The location of a file containing Elasticsearch basic authentication\n                         credentials, as properties. The username property is\n                         `zipkin.storage.elasticsearch.username`, password `zipkin.storage.elasticsearch.password`.\n                         This file is reloaded periodically, using `ES_CREDENTIALS_REFRESH_INTERVAL`\n                         as the interval. This parameter takes precedence over ES_USERNAME and\n                          ES_PASSWORD when specified.\n* `ES_CREDENTIALS_REFRESH_INTERVAL`: Credentials refresh interval in seconds, which defaults to\n                                     1 second. This is the maximum amount of time spans will drop due to stale\n                                     credentials. Any errors reading the credentials file occur in logs at this rate.\n* `ES_HTTP_LOGGING`: When set, controls the volume of HTTP logging of the Elasticsearch API.\n                     Options are BASIC, HEADERS, BODY\n* `ES_SSL_NO_VERIFY`: When true, disables the verification of server's key certificate chain.\n                      This is not appropriate for production. Defaults to false.\n* `ES_TEMPLATE_PRIORITY`: The priority value of the composable index templates. This is only applicable\n                          for ES version 7.8 or above. Must be set, even to 0, to use composable template\n")])])]),a("p",[e._v("Example usage:")]),e._v(" "),a("p",[e._v("To connect normally:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("STORAGE_TYPE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("elasticsearch "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ES_HOSTS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("http://myhost:9200 java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("To log Elasticsearch API requests:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("STORAGE_TYPE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("elasticsearch "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ES_HTTP_LOGGING")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("BASIC java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h4",{attrs:{id:"using-a-custom-key-store-or-trust-store-ssl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#using-a-custom-key-store-or-trust-store-ssl"}},[e._v("#")]),e._v(" Using a custom Key Store or Trust Store (SSL)")]),e._v(" "),a("p",[e._v("If your Elasticsearch endpoint customized SSL configuration (for example self-signed) certificates,\nyou can use any of the following "),a("a",{attrs:{href:"https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html#T6",target:"_blank",rel:"noopener noreferrer"}},[e._v("subset of JSSE properties"),a("OutboundLink")],1),e._v(" to connect.")]),e._v(" "),a("ul",[a("li",[e._v("javax.net.ssl.keyStore")]),e._v(" "),a("li",[e._v("javax.net.ssl.keyStorePassword")]),e._v(" "),a("li",[e._v("javax.net.ssl.keyStoreType")]),e._v(" "),a("li",[e._v("javax.net.ssl.trustStore")]),e._v(" "),a("li",[e._v("javax.net.ssl.trustStorePassword")]),e._v(" "),a("li",[e._v("javax.net.ssl.trustStoreType")])]),e._v(" "),a("p",[e._v("Usage example:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("JAVA_OPTS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'-Djavax.net.ssl.keyStore=keystore.p12 -Djavax.net.ssl.keyStorePassword=keypassword -Djavax.net.ssl.keyStoreType=PKCS12 -Djavax.net.ssl.trustStore=truststore.p12 -Djavax.net.ssl.trustStorePassword=trustpassword -Djavax.net.ssl.trustStoreType=PKCS12'")]),e._v("\n$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("STORAGE_TYPE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("elasticsearch java "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$JAVA_OPTS")]),e._v(" -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("Under the scenes, these map to properties prefixed "),a("code",[e._v("zipkin.storage.elasticsearch.ssl.")]),e._v(", which affect\nthe Armeria client used to connect to Elasticsearch.")]),e._v(" "),a("p",[e._v("The above properties allow the most common SSL setup to work out of box. If you need more\ncustomization, please make a comment in "),a("a",{attrs:{href:"https://github.com/openzipkin/zipkin/issues/2774",target:"_blank",rel:"noopener noreferrer"}},[e._v("this issue"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("h4",{attrs:{id:"automatic-index-creation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#automatic-index-creation"}},[e._v("#")]),e._v(" Automatic Index Creation")]),e._v(" "),a("p",[e._v("Zipkin will automatically create new indices as needed. Elasticsearch by default "),a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#index-creation",target:"_blank",rel:"noopener noreferrer"}},[e._v("allows"),a("OutboundLink")],1),e._v(" automatic creation of said indices, though your local install may have been configured to disallow it. You can verify this in the cluster settings: "),a("code",[e._v("action.auto_create_index: false")]),e._v(".")]),e._v(" "),a("h3",{attrs:{id:"legacy-v1-storage-components"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#legacy-v1-storage-components"}},[e._v("#")]),e._v(" Legacy (v1) storage components")]),e._v(" "),a("p",[e._v('The following components are no longer encouraged, but exist to help aid\ntransition to supported ones. These are indicated as "v1" as they use\ndata layouts based on Zipkin\'s V1 Thrift model, as opposed to the\nsimpler v2 data model currently used.')]),e._v(" "),a("h4",{attrs:{id:"mysql-storage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-storage"}},[e._v("#")]),e._v(" MySQL Storage")]),e._v(" "),a("p",[e._v("Zipkin's "),a("a",{attrs:{href:"../zipkin-storage/mysql-v1"}},[e._v("MySQL component")]),e._v(" is tested against MySQL\n5.7 and applies when "),a("code",[e._v("STORAGE_TYPE")]),e._v(" is set to "),a("code",[e._v("mysql")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v('* `MYSQL_DB`: The database to use. Defaults to "zipkin".\n* `MYSQL_USER` and `MYSQL_PASS`: MySQL authentication, which defaults to empty string.\n* `MYSQL_HOST`: Defaults to localhost\n* `MYSQL_TCP_PORT`: Defaults to 3306\n* `MYSQL_MAX_CONNECTIONS`: Maximum concurrent connections, defaults to 10\n* `MYSQL_USE_SSL`: Requires `javax.net.ssl.trustStore` and `javax.net.ssl.trustStorePassword`, defaults to false.\n')])])]),a("p",[e._v("Note: This module is not recommended for production usage. Before using this,\nyou must "),a("a",{attrs:{href:"../zipkin-storage/mysql-v1#applying-the-schema"}},[e._v("apply the schema")]),e._v(".")]),e._v(" "),a("p",[e._v("Alternatively you can use "),a("code",[e._v("MYSQL_JDBC_URL")]),e._v(" and specify the complete JDBC url yourself. Note that the URL constructed by\nusing the separate settings above will also include the following parameters:\n"),a("code",[e._v("?autoReconnect=true&useSSL=false&useUnicode=yes&characterEncoding=UTF-8")]),e._v(". If you specify the JDBC url yourself, add\nthese parameters as well.")]),e._v(" "),a("p",[e._v("Example usage:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("STORAGE_TYPE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("mysql "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("MYSQL_USER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("root java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h3",{attrs:{id:"throttled-storage-experimental"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#throttled-storage-experimental"}},[e._v("#")]),e._v(" Throttled Storage (Experimental)")]),e._v(" "),a("p",[e._v("These settings can be used to help tune the rate at which Zipkin flushes data to another, underlying\n"),a("code",[e._v("StorageComponent")]),e._v(" (such as Elasticsearch):")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v("* `STORAGE_THROTTLE_ENABLED`: Enables throttling\n* `STORAGE_THROTTLE_MIN_CONCURRENCY`: Minimum number of Threads to use for writing to storage.\n* `STORAGE_THROTTLE_MAX_CONCURRENCY`: Maximum number of Threads to use for writing to storage.\n* `STORAGE_THROTTLE_MAX_QUEUE_SIZE`: How many messages to buffer while all Threads are writing data before abandoning a message (0 = no buffering).\n")])])]),a("p",[e._v("As this feature is experimental, it is not recommended to run this in production environments.")]),e._v(" "),a("h2",{attrs:{id:"collector-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#collector-2"}},[e._v("#")]),e._v(" Collector")]),e._v(" "),a("h3",{attrs:{id:"http-collector"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-collector"}},[e._v("#")]),e._v(" HTTP Collector")]),e._v(" "),a("p",[e._v("The HTTP collector is enabled by default. It accepts spans via "),a("code",[e._v("POST /api/v1/spans")]),e._v(" and "),a("code",[e._v("POST /api/v2/spans")]),e._v(".\nThe HTTP collector supports the following configuration:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Property")]),e._v(" "),a("th",[e._v("Environment Variable")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("code",[e._v("zipkin.collector.http.enabled")])]),e._v(" "),a("td",[a("code",[e._v("COLLECTOR_HTTP_ENABLED")])]),e._v(" "),a("td",[a("code",[e._v("false")]),e._v(" disables the HTTP collector. Defaults to "),a("code",[e._v("true")]),e._v(".")])])])]),e._v(" "),a("h3",{attrs:{id:"scribe-legacy-collector"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#scribe-legacy-collector"}},[e._v("#")]),e._v(" Scribe (Legacy) Collector")]),e._v(" "),a("p",[e._v("A collector supporting Scribe is enabled when "),a("code",[e._v("COLLECTOR_SCRIBE_ENABLED=true")]),e._v(". New\nsites are discouraged from using this collector as Scribe is an archived\ntechnology.")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Environment Variable")]),e._v(" "),a("th",[e._v("Property")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("code",[e._v("COLLECTOR_PORT")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.scribe.port")])]),e._v(" "),a("td",[e._v("The port to listen for thrift RPC scribe requests. Defaults to 9410")])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("SCRIBE_CATEGORY")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.scribe.category")])]),e._v(" "),a("td",[e._v("Category zipkin spans will be consumed from. Defaults to "),a("code",[e._v("zipkin")])])])])]),e._v(" "),a("h3",{attrs:{id:"activemq-collector"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#activemq-collector"}},[e._v("#")]),e._v(" ActiveMQ Collector")]),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"../zipkin-collector/activemq"}},[e._v("ActiveMQ Collector")]),e._v(" is enabled when "),a("code",[e._v("ACTIVEMQ_URL")]),e._v(" is set to a v5.x broker. The following settings apply in this case.")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Environment Variable")]),e._v(" "),a("th",[e._v("Property")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("code",[e._v("COLLECTOR_ACTIVEMQ_ENABLED")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.enabled")])]),e._v(" "),a("td",[a("code",[e._v("false")]),e._v(" disables the ActiveMQ collector. Defaults to "),a("code",[e._v("true")]),e._v(".")])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_URL")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.url")])]),e._v(" "),a("td",[a("a",{attrs:{href:"https://activemq.apache.org/uri-protocols",target:"_blank",rel:"noopener noreferrer"}},[e._v("Connection URL"),a("OutboundLink")],1),e._v(" to the ActiveMQ broker, ex. "),a("code",[e._v("tcp://localhost:61616")]),e._v(" or "),a("code",[e._v("failover:(tcp://localhost:61616,tcp://remotehost:61616)")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_QUEUE")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.queue")])]),e._v(" "),a("td",[e._v("Queue from which to collect span messages. Defaults to "),a("code",[e._v("zipkin")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_CLIENT_ID_PREFIX")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.client-id-prefix")])]),e._v(" "),a("td",[e._v("Client ID prefix for queue consumers. Defaults to "),a("code",[e._v("zipkin")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_CONCURRENCY")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.concurrency")])]),e._v(" "),a("td",[e._v("Number of concurrent span consumers. Defaults to "),a("code",[e._v("1")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_USERNAME")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.username")])]),e._v(" "),a("td",[e._v("Optional username to connect to the broker")])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_PASSWORD")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.password")])]),e._v(" "),a("td",[e._v("Optional password to connect to the broker")])])])]),e._v(" "),a("p",[e._v("Example usage:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ACTIVEMQ_URL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("tcp://localhost:61616 java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h3",{attrs:{id:"kafka-collector"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kafka-collector"}},[e._v("#")]),e._v(" Kafka Collector")]),e._v(" "),a("p",[e._v("The Kafka collector is enabled when "),a("code",[e._v("KAFKA_BOOTSTRAP_SERVERS")]),e._v(' is set to\na v0.10+ server. The following settings apply in this case. Some settings\ncorrespond to "New Consumer Configs" in '),a("a",{attrs:{href:"https://kafka.apache.org/documentation/#newconsumerconfigs",target:"_blank",rel:"noopener noreferrer"}},[e._v("Kafka documentation"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Variable")]),e._v(" "),a("th",[e._v("New Consumer Config")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("code",[e._v("COLLECTOR_KAFKA_ENABLED")])]),e._v(" "),a("td",[e._v("N/A")]),e._v(" "),a("td",[a("code",[e._v("false")]),e._v(" disables the Kafka collector. Defaults to "),a("code",[e._v("true")]),e._v(".")])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("KAFKA_BOOTSTRAP_SERVERS")])]),e._v(" "),a("td",[e._v("bootstrap.servers")]),e._v(" "),a("td",[e._v("Comma-separated list of brokers, ex. 127.0.0.1:9092. No default")])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("KAFKA_GROUP_ID")])]),e._v(" "),a("td",[e._v("group.id")]),e._v(" "),a("td",[e._v("The consumer group this process is consuming on behalf of. Defaults to "),a("code",[e._v("zipkin")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("KAFKA_TOPIC")])]),e._v(" "),a("td",[e._v("N/A")]),e._v(" "),a("td",[e._v("Comma-separated list of topics that zipkin spans will be consumed from. Defaults to "),a("code",[e._v("zipkin")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("KAFKA_STREAMS")])]),e._v(" "),a("td",[e._v("N/A")]),e._v(" "),a("td",[e._v("Count of threads consuming the topic. Defaults to "),a("code",[e._v("1")])])])])]),e._v(" "),a("p",[e._v("Example usage:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KAFKA_BOOTSTRAP_SERVERS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),e._v(".0.1:9092 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("h4",{attrs:{id:"other-kafka-consumer-properties"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#other-kafka-consumer-properties"}},[e._v("#")]),e._v(" Other Kafka consumer properties")]),e._v(" "),a("p",[e._v("You may need to set other\n"),a("a",{attrs:{href:"https://kafka.apache.org/documentation/#newconsumerconfigs",target:"_blank",rel:"noopener noreferrer"}},[e._v("Kafka consumer properties"),a("OutboundLink")],1),e._v(", in\naddition to the ones with explicit properties defined by the collector. In this case, you need to\nprefix that property name with "),a("code",[e._v("zipkin.collector.kafka.overrides")]),e._v(" and pass it as a system property\nargument.")]),e._v(" "),a("p",[e._v("For example, to override "),a("code",[e._v("auto.offset.reset")]),e._v(", you can set a system property named\n"),a("code",[e._v("zipkin.collector.kafka.overrides.auto.offset.reset")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KAFKA_BOOTSTRAP_SERVERS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),e._v(".0.1:9092 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    java -Dzipkin.collector.kafka.overrides.auto.offset.reset"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("latest -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("h4",{attrs:{id:"detailed-examples"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#detailed-examples"}},[e._v("#")]),e._v(" Detailed examples")]),e._v(" "),a("p",[e._v("Example targeting Kafka running in Docker:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KAFKA_BOOTSTRAP_SERVERS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),e._v("docker-machine "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("ip")]),e._v(" `docker-machine active`"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Run Kafka in the background")]),e._v("\n$ docker run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("9092")]),e._v(":9092 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    --env "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ADVERTISED_HOST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$KAFKA_BOOTSTRAP_SERVERS")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    --env "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("AUTO_CREATE_TOPICS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    spotify/kafka\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Start the zipkin server, which reads $KAFKA_BOOTSTRAP_SERVERS")]),e._v("\n$ java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br")])]),a("p",[e._v("Multiple bootstrap servers:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KAFKA_BOOTSTRAP_SERVERS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("broker1.local:9092,broker2.local:9092 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("Alternate topic name(s):")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KAFKA_BOOTSTRAP_SERVERS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),e._v(".0.1:9092 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    java -Dzipkin.collector.kafka.topic"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("zapkin,zipken -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("Specifying bootstrap servers as a system property, instead of an environment variable:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ java -Dzipkin.collector.kafka.bootstrap-servers"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),e._v(".0.1:9092 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("h3",{attrs:{id:"rabbitmq-collector"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rabbitmq-collector"}},[e._v("#")]),e._v(" RabbitMQ collector")]),e._v(" "),a("p",[e._v("The "),a("a",{attrs:{href:"../zipkin-collector/rabbitmq"}},[e._v("RabbitMQ collector")]),e._v(" will be enabled when the "),a("code",[e._v("addresses")]),e._v(" or "),a("code",[e._v("uri")]),e._v(" for the RabbitMQ server(s) is set.")]),e._v(" "),a("p",[e._v("Example usage:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("RABBIT_ADDRESSES")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("localhost java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h3",{attrs:{id:"grpc-collector-experimental"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#grpc-collector-experimental"}},[e._v("#")]),e._v(" gRPC Collector (Experimental)")]),e._v(" "),a("p",[e._v("You can enable a gRPC span collector endpoint by setting "),a("code",[e._v("COLLECTOR_GRPC_ENABLED=true")]),e._v(". The\n"),a("code",[e._v("zipkin.proto3.SpanService/Report")]),e._v(" endpoint will run on the same port as normal HTTP (9411).")]),e._v(" "),a("p",[e._v("Example usage:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("COLLECTOR_GRPC_ENABLED")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("true java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("As this service is experimental, it is not recommended to run this in production environments.")]),e._v(" "),a("h2",{attrs:{id:"self-tracing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#self-tracing"}},[e._v("#")]),e._v(" Self-Tracing")]),e._v(" "),a("p",[e._v("Self tracing exists to help troubleshoot performance of the zipkin-server. Production deployments\nwho enable self-tracing should lower the sample rate from 1.0 (100%) to a much smaller rate, like\n0.001 (0.1% or 1 out of 1000).")]),e._v(" "),a("p",[e._v("When "),a("code",[e._v("zipkin.self-tracing.enabled=true")]),e._v(', Zipkin will self-trace calls to the API under the service\nname "zipkin-server".')]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Variable")]),e._v(" "),a("th",[e._v("Property")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("SELF_TRACING_ENABLED")]),e._v(" "),a("td",[e._v("zipkin.self-tracing.enabled")]),e._v(" "),a("td",[e._v("Set to true to enable self-tracing. Defaults to false")])]),e._v(" "),a("tr",[a("td",[e._v("SELF_TRACING_SAMPLE_RATE")]),e._v(" "),a("td",[e._v("zipkin.self-tracing.sample-rate")]),e._v(" "),a("td",[e._v("Percentage of self-traces to retain, defaults to always sample (1.0).")])]),e._v(" "),a("tr",[a("td",[e._v("SELF_TRACING_FLUSH_INTERVAL")]),e._v(" "),a("td",[e._v("zipkin.self-tracing.flush-interval")]),e._v(" "),a("td",[e._v("Interval in seconds to flush self-tracing data to storage. Defaults to 1")])])])]),e._v(" "),a("h3",{attrs:{id:"_128-bit-trace-ids"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_128-bit-trace-ids"}},[e._v("#")]),e._v(" 128-bit trace IDs")]),e._v(" "),a("p",[e._v("Zipkin supports 64 and 128-bit trace identifiers, typically serialized\nas 16 or 32 character hex strings. By default, spans reported to zipkin\nwith the same trace ID will be considered in the same trace.")]),e._v(" "),a("p",[e._v("For example, "),a("code",[e._v("463ac35c9f6413ad48485a3953bb6124")]),e._v(" is a 128-bit trace ID,\nwhile "),a("code",[e._v("48485a3953bb6124")]),e._v(" is a 64-bit one.")]),e._v(" "),a("p",[e._v("Note: Span (or parent) IDs within a trace are 64-bit regardless of the\nlength or value of their trace ID.")]),e._v(" "),a("h4",{attrs:{id:"migrating-from-64-to-128-bit-trace-ids"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#migrating-from-64-to-128-bit-trace-ids"}},[e._v("#")]),e._v(" Migrating from 64 to 128-bit trace IDs")]),e._v(" "),a("p",[e._v("Unless you only issue 128-bit traces when all applications support them,\nthe process of updating applications from 64 to 128-bit trace IDs results\nin a mixed state. This mixed state is mitigated by the setting\n"),a("code",[e._v("STRICT_TRACE_ID=false")]),e._v(", explained below. Once a migration is complete,\nremove the setting "),a("code",[e._v("STRICT_TRACE_ID=false")]),e._v(" or set it to true.")]),e._v(" "),a("p",[e._v("Here are a few trace IDs the help what happens during this setting.")]),e._v(" "),a("ul",[a("li",[e._v("Trace ID A: 463ac35c9f6413ad48485a3953bb6124")]),e._v(" "),a("li",[e._v("Trace ID B: 48485a3953bb6124")]),e._v(" "),a("li",[e._v("Trace ID C: 463ac35c9f6413adf1a48a8cff464e0e")]),e._v(" "),a("li",[e._v("Trace ID D: 463ac35c9f6413ad")])]),e._v(" "),a("p",[e._v("In a 64-bit environment, trace IDs will look like B or D above. When an\napplication upgrades to 128-bit instrumentation and decides to create a\n128-bit trace, its trace IDs will look like A or C above.")]),e._v(" "),a("p",[e._v("Applications who aren't yet 128-bit capable typically only retain the\nright-most 16 characters of the trace ID. When this happens, the same\ntrace could be reported as trace ID A or trace ID B.")]),e._v(" "),a("p",[e._v("By default, Zipkin will think these are different trace IDs, as they are\ndifferent strings. During a transition from 64-128 bit trace IDs, spans\nwould appear split across two IDs. For example, it might start as trace\nID A, but the next hop might truncate it to trace ID B. This would render\nthe system unusable for applications performing upgrades.")]),e._v(" "),a("p",[e._v("One way to address this problem is to not use 128-bit trace IDs until\nall applications support them. This prevents a mixed scenario at the cost\nof coordination. Another way is to set "),a("code",[e._v("STRICT_TRACE_ID=false")]),e._v(".")]),e._v(" "),a("p",[e._v("When "),a("code",[e._v("STRICT_TRACE_ID=false")]),e._v(", only the right-most 16 of a 32 character\ntrace ID are considered when grouping or retrieving traces. This setting\nshould only be applied when transitioning from 64 to 128-bit trace IDs\nand removed once the transition is complete.")]),e._v(" "),a("p",[e._v("See https://github.com/openzipkin/b3-propagation/issues/6 for the status\nof known open source libraries on 128-bit trace identifiers.")]),e._v(" "),a("p",[e._v("See "),a("code",[e._v("zipkin2.storage.StorageComponent.Builder")]),e._v(" for even more details!")]),e._v(" "),a("h2",{attrs:{id:"tls-ssl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tls-ssl"}},[e._v("#")]),e._v(" TLS/SSL")]),e._v(" "),a("p",[e._v("Zipkin-server can be made to run with TLS if needed:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# assuming you generate the key like this")]),e._v("\nkeytool -genkeypair -alias mysite -keyalg RSA -keysize "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2048")]),e._v(" -storetype PKCS12 -keystore zipkin.p12 -validity "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3650")]),e._v("\n\njava -jar zipkin.jar --armeria.ssl.key-store"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("zipkin.p12 --armeria.ssl.key-store-type"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("PKCS12 --armeria.ssl.key-store-password"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("123123")]),e._v(" --armeria.ssl.key-alias"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("mysite  --armeria.ssl.enabled"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("true --armeria.ports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(".port"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("9411")]),e._v(" --armeria.ports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(".protocols"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("https\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("h2",{attrs:{id:"running-with-docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#running-with-docker"}},[e._v("#")]),e._v(" Running with Docker")]),e._v(" "),a("p",[e._v("Released versions of zipkin-server are published to Docker Hub as "),a("code",[e._v("openzipkin/zipkin")]),e._v(".\nSee "),a("a",{attrs:{href:"https://github.com/openzipkin/docker-zipkin",target:"_blank",rel:"noopener noreferrer"}},[e._v("docker-zipkin"),a("OutboundLink")],1),e._v(" for details.")]),e._v(" "),a("h2",{attrs:{id:"building-locally"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#building-locally"}},[e._v("#")]),e._v(" Building locally")]),e._v(" "),a("p",[e._v("To build and run the server from the currently checked out source, enter the following.")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Build the server and also make its dependencies")]),e._v("\n$ ./mvnw -T1C -q --batch-mode -DskipTests --also-make -pl zipkin-server clean package\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Run the server")]),e._v("\n$ java -jar ./zipkin-server/target/zipkin-server-*exec.jar\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# or Run the slim server")]),e._v("\n$ java -jar ./zipkin-server/target/zipkin-server-*slim.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br")])])])}),[],!1,null,null,null);t.default=r.exports},1115:function(e,t,a){"use strict";a.r(t);var s=a(1),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"zipkin-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zipkin-server"}},[e._v("#")]),e._v(" zipkin-server")]),e._v(" "),a("p",[e._v("Zipkin Server 是一个 Java 1.8+ 服务，打包为一个可执行的 jar。 跨度存储和收集器是可配置的。默认情况下，存储在内存中，启用 HTTP 收集器（POST /api/v2/spans 端点），服务器侦听端口 9411。 Zipkin Server 使用 "),a("a",{attrs:{href:"https://github.com/line/armeria",target:"_blank",rel:"noopener noreferrer"}},[e._v("Armeria"),a("OutboundLink")],1),e._v(" 实现。 虽然它在内部使用 Spring Boot  （打开新窗口）\n，不应将 Zipkin Server 视为普通的 "),a("a",{attrs:{href:"http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring Boot"),a("OutboundLink")],1),e._v(" 应用程序。")]),e._v(" "),a("h2",{attrs:{id:"不支持自定义服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#不支持自定义服务器"}},[e._v("#")]),e._v(" 不支持自定义服务器")]),e._v(" "),a("p",[e._v("不支持通过类似于 spring boot 应用程序添加 "),a("code",[e._v("zipkin-server")]),e._v(" 引用这种方式来构建服务。")]),e._v(" "),a("h2",{attrs:{id:"快速启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#快速启动"}},[e._v("#")]),e._v(" 快速启动")]),e._v(" "),a("p",[e._v("最快的上手方式是通过 "),a("a",{attrs:{href:"https://search.maven.org/remote_content?g=io.zipkin&a=zipkin-server&v=LATEST&c=exec",target:"_blank",rel:"noopener noreferrer"}},[e._v("最新 jar 发布服务器"),a("OutboundLink")],1),e._v(" 获取一个独立的可执行jar。请注意，Zipkin 服务器需要最低 JRE 8。")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" -sSL https://zipkin.io/quickstart.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("bash")]),e._v(" -s\n$ java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("启动后，浏览 http://your_host:9411 验证")]),e._v(" "),a("h2",{attrs:{id:"端点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#端点"}},[e._v("#")]),e._v(" 端点")]),e._v(" "),a("p",[e._v("以下端点在服务基础url http://your_host:9411 下定义")]),e._v(" "),a("ul",[a("li",[e._v("/ - "),a("a",{attrs:{href:"../zipkin-ui"}},[e._v("UI")])]),e._v(" "),a("li",[e._v("/config.json - UI 配置")]),e._v(" "),a("li",[e._v("/api/v2 - "),a("a",{attrs:{href:"https://zipkin.io/zipkin-api/#/",target:"_blank",rel:"noopener noreferrer"}},[e._v("API"),a("OutboundLink")],1)]),e._v(" "),a("li",[e._v("/health - 如果正常则返回 200")]),e._v(" "),a("li",[e._v("/info - 提供正在运行的实例的版本")]),e._v(" "),a("li",[e._v("/metrics - 包括按传输类型细分的收集器指标")]),e._v(" "),a("li",[e._v("/prometheus - Prometheus 抓取端点")])]),e._v(" "),a("p",[a("a",{attrs:{href:"https://zipkin.io/zipkin-api/#/",target:"_blank",rel:"noopener noreferrer"}},[e._v("旧版 /api/v1 API"),a("OutboundLink")],1),e._v(" 仍然支持。后端通过数据转换与 HTTP API 分离。这意味着您仍然可以在新后端接受旧数据，反之亦然。进入 "),a("code",[e._v("https://zipkin.io/zipkin-api/zipkin-api.yaml")]),e._v(" Swagger UI 的探索框查看旧定义")]),e._v(" "),a("h3",{attrs:{id:"cors-跨域资源共享"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cors-跨域资源共享"}},[e._v("#")]),e._v(" CORS（跨域资源共享）")]),e._v(" "),a("p",[e._v("默认情况下，所有端点 "),a("code",[e._v("/api/v2")]),e._v(" 都配置为允许跨域请求。")]),e._v(" "),a("p",[e._v("这可以通过修改 "),a("code",[e._v("zipkin.query.allowed-origins")]),e._v(" 属性来改变。")]),e._v(" "),a("p",[e._v("例如，要允许来自 "),a("code",[e._v("http://foo.bar.com")]),e._v(" 域名下的 CORS 请求：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("ZIPKIN_QUERY_ALLOWED_ORIGINS=http://foo.bar.com\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("更多的相关配置请看 "),a("a",{attrs:{href:"#%E9%85%8D%E7%BD%AE"}},[e._v("这里")]),e._v(" 。")]),e._v(" "),a("h3",{attrs:{id:"服务和跨度名称查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务和跨度名称查询"}},[e._v("#")]),e._v(" 服务和跨度名称查询")]),e._v(" "),a("p",[e._v("Zipkin "),a("a",{attrs:{href:"https://zipkin.io/zipkin-api/#/default/get_services",target:"_blank",rel:"noopener noreferrer"}},[e._v("API"),a("OutboundLink")],1),e._v(" 不包括返回多远查找服务或跨度名称的参数。为了防止负载过大，服务和跨度名称查询通过配置\n"),a("code",[e._v("QUERY_LOOKBACK")]),e._v(" 限制，默认为24小时（每天两个桶：今天一个，昨天一个）")]),e._v(" "),a("h2",{attrs:{id:"日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日志"}},[e._v("#")]),e._v(" 日志")]),e._v(" "),a("p",[e._v("默认情况下， zipkin 以 INFO 或更高级别将日志写入控制台。所以可以通过配置  "),a("code",[e._v("logging.level.XXX")]),e._v(" 属性调整日志级别")]),e._v(" "),a("p",[e._v("例如，如果您想为所有 zipkin 类别启用调试日志记录，您可以像这样启动服务器：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ java -jar zipkin.jar --logging.level.zipkin2"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("DEBUG\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("更多的相关配置请看 "),a("a",{attrs:{href:"#%E9%85%8D%E7%BD%AE"}},[e._v("这里")]),e._v(" 。")]),e._v(" "),a("h3",{attrs:{id:"高级日志配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#高级日志配置"}},[e._v("#")]),e._v(" 高级日志配置")]),e._v(" "),a("p",[e._v("实际上，服务器使用 "),a("a",{attrs:{href:"http://docs.spring.io/spring-boot/docs/current/reference/html/howto-logging.html#howto-configure-logback-for-logging",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring Boot - Logback集成"),a("OutboundLink")],1),e._v(" 处理日志，所以可以通过配置 "),a("code",[e._v("--logging.exception-conversion-word=%wEx{full}")]),e._v(" 转储完整堆栈跟踪而不是截断的跟踪。")]),e._v(" "),a("h2",{attrs:{id:"metrics"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#metrics"}},[e._v("#")]),e._v(" Metrics")]),e._v(" "),a("p",[e._v("收集器指标被导出到路径 "),a("code",[e._v("/metrics")]),e._v(" 。这些和其他指标被导出到路径 "),a("code",[e._v("/prometheus")]),e._v(" 。")]),e._v(" "),a("h3",{attrs:{id:"示例-prometheus-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#示例-prometheus-配置"}},[e._v("#")]),e._v(" 示例 Prometheus 配置")]),e._v(" "),a("p",[e._v("Here's an example "),a("code",[e._v("/prometheus")]),e._v(" configuration, using the Prometheus\nexposition [text format version 0.0.4]")]),e._v(" "),a("p",[e._v("这是一个示例 "),a("code",[e._v("/prometheus")]),e._v(" 配置，使用 Prometheus exposition"),a("a",{attrs:{href:"https://prometheus.io/docs/instrumenting/exposition_formats/",target:"_blank",rel:"noopener noreferrer"}},[e._v("文本格式版本 0.0.4"),a("OutboundLink")],1)]),e._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[e._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("job_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'zipkin'")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("scrape_interval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 5s\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("metrics_path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'/prometheus'")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("static_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("targets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'localhost:9411'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("metric_relabel_configs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Response code count")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("__name__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'^status_(\\d+)_(.*)$'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'${1}'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" status\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("__name__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'^status_(\\d+)_(.*)$'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'${2}'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" path\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("source_labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("__name__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("regex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'^status_(\\d+)_(.*)$'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("replacement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'http_requests_total'")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("target_label")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" __name__\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br"),a("span",{staticClass:"line-number"},[e._v("10")]),a("br"),a("span",{staticClass:"line-number"},[e._v("11")]),a("br"),a("span",{staticClass:"line-number"},[e._v("12")]),a("br"),a("span",{staticClass:"line-number"},[e._v("13")]),a("br"),a("span",{staticClass:"line-number"},[e._v("14")]),a("br"),a("span",{staticClass:"line-number"},[e._v("15")]),a("br"),a("span",{staticClass:"line-number"},[e._v("16")]),a("br"),a("span",{staticClass:"line-number"},[e._v("17")]),a("br"),a("span",{staticClass:"line-number"},[e._v("18")]),a("br"),a("span",{staticClass:"line-number"},[e._v("19")]),a("br")])]),a("h3",{attrs:{id:"收集器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#收集器"}},[e._v("#")]),e._v(" 收集器")]),e._v(" "),a("p",[e._v("Metric 收集器按传输细分。以下内容被导出到 "),a("code",[e._v("/metrics")]),e._v(" 端点：")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Metric")]),e._v(" "),a("th",[e._v("说明")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("counter.zipkin_collector.messages.$transport")]),e._v(" "),a("td",[e._v("收到的累积消息；应该与检测应用程序报告的消息相关")])]),e._v(" "),a("tr",[a("td",[e._v("counter.zipkin_collector.messages_dropped.$transport")]),e._v(" "),a("td",[e._v("累积消息丢弃；原因包括客户端断开连接或格式错误的内容")])]),e._v(" "),a("tr",[a("td",[e._v("counter.zipkin_collector.bytes.$transport")]),e._v(" "),a("td",[e._v("累积消息字节")])]),e._v(" "),a("tr",[a("td",[e._v("counter.zipkin_collector.spans.$transport")]),e._v(" "),a("td",[e._v("累积跨度读取；应该与检测应用程序报告的消息相关")])]),e._v(" "),a("tr",[a("td",[e._v("counter.zipkin_collector.spans_dropped.$transport")]),e._v(" "),a("td",[e._v("累积跨度下降；原因包括采样或存储故障")])]),e._v(" "),a("tr",[a("td",[e._v("gauge.zipkin_collector.message_spans.$transport")]),e._v(" "),a("td",[e._v("消息中的最后一个跨度计数")])]),e._v(" "),a("tr",[a("td",[e._v("gauge.zipkin_collector.message_bytes.$transport")]),e._v(" "),a("td",[e._v("消息中的最后一个字节数")])])])]),e._v(" "),a("h2",{attrs:{id:"配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[e._v("#")]),e._v(" 配置")]),e._v(" "),a("p",[e._v("我们支持 ENV 变量配置，例如 "),a("code",[e._v("STORAGE_TYPE=cassandra3")]),e._v(" ，因为它们为管理员所熟悉，并且易于在 Docker 等运行时环境中使用")]),e._v(" "),a("p",[e._v("以下是 Zipkin 的顶层配置：")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("QUERY_PORT")]),e._v(": HTTP API 和 Web UI 的监听端口；默认为 "),a("code",[e._v("9411")])]),e._v(" "),a("li",[a("code",[e._v("QUERY_ENABLED")]),e._v(": 配置 "),a("code",[e._v("false")]),e._v(" 禁用 '/api/v2' 端点。这也会导致 UI 不可用，因为 UI 依赖于 API。 如果您的唯一目标是限制搜索, 请配置 "),a("code",[e._v("SEARCH_ENABLED")]),e._v(" 为 "),a("code",[e._v("false")])]),e._v(" "),a("li",[a("code",[e._v("SEARCH_ENABLED")]),e._v(": "),a("code",[e._v("false")]),e._v(" 禁用查询 API 中的搜索以及收集器中的任何索引或后处理以支持搜索。这不会禁用整个 UI ，因为按 ID 和依赖项查询的跟踪仍在运行。当您使用其他服务（例如日志）来查找跟踪 ID 时禁用此功能。默认为 true")]),e._v(" "),a("li",[a("code",[e._v("QUERY_TIMEOUT")]),e._v(": 设置查询请求的硬超时。接受任何持续时间字符串（例如， "),a("code",[e._v("100ms")]),e._v(" ）。值 "),a("code",[e._v("0")]),e._v(" 将完全禁用超时。默认为 "),a("code",[e._v("11s")]),e._v(" 。")]),e._v(" "),a("li",[a("code",[e._v("QUERY_LOG_LEVEL")]),e._v(": 写入控制台的日志级别；默认为 "),a("code",[e._v("INFO")])]),e._v(" "),a("li",[a("code",[e._v("QUERY_NAMES_MAX_AGE")]),e._v(": 控制 zipkin-server 对 UI 请求的最大响应时间。默认为 300 秒。")]),e._v(" "),a("li",[a("code",[e._v("QUERY_LOOKBACK")]),e._v(": 从 endTs 可以回溯多少毫秒查询；默认为 24​​ 小时（每天两个时段：今天一个，昨天一个）")]),e._v(" "),a("li",[a("code",[e._v("STORAGE_TYPE")]),e._v(": SpanStore 实现: "),a("code",[e._v("mem")]),e._v(", "),a("code",[e._v("mysql")]),e._v(", "),a("code",[e._v("cassandra3")]),e._v(", "),a("code",[e._v("elasticsearch")]),e._v(" 中取一个")]),e._v(" "),a("li",[a("code",[e._v("COLLECTOR_SAMPLE_RATE")]),e._v(": 保留的记录道百分比，默认为“始终采样”（1.0）。")]),e._v(" "),a("li",[a("code",[e._v("AUTOCOMPLETE_KEYS")]),e._v(": 会通过 "),a("code",[e._v("/api/v2/autocompleteTags")]),e._v(' 端点返回的跨度标签键列表；标签键应以逗号分隔，例如 "instance_id,user_id,env"')]),e._v(" "),a("li",[a("code",[e._v("AUTOCOMPLETE_TTL")]),e._v(": 以毫秒为单位抑制调用写入相同的自动完成键/值对的时间。默认 3600000（1 小时）")])]),e._v(" "),a("h3",{attrs:{id:"配置文件覆盖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置文件覆盖"}},[e._v("#")]),e._v(" 配置文件覆盖")]),e._v(" "),a("p",[e._v("在场景下，所有配置都由 Spring Boot 管理。这意味着属性也可能被系统属性或 "),a("a",{attrs:{href:"https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring Boot"),a("OutboundLink")],1),e._v(" 支持的任何其他替代方案覆盖")]),e._v(" "),a("p",[e._v("我们使用 yaml 配置将更短或更惯用的 ENV 变量绑定到最终使用的 Spring 属性。虽然大多数用户应该只使用环境变量，但有些用户可能希望使用属性文件方法来覆盖设置。例如，知道我们设置 "),a("code",[e._v("spring.config.name=zipkin-server")]),e._v(" 了 ，Spring Boot 会自动在当前目录中查找一个名为的文件 "),a("code",[e._v("zipkin-server.properties")]),e._v(" ，并且可以通过这种方式覆盖我们在 yaml 中设置的相同属性。")]),e._v(" "),a("p",[e._v("如果您选择使用基于属性的配置而不是 ENV 变量，那么您就是在自定义配置。这意味着您将使用 "),a("a",{attrs:{href:"https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring Boot 文档"),a("OutboundLink")],1),e._v(" 或 "),a("a",{attrs:{href:"https://stackoverflow.com/questions/tagged/spring-boot",target:"_blank",rel:"noopener noreferrer"}},[e._v("堆栈溢出"),a("OutboundLink")],1),e._v(" 解决参数配置问题，而不是提出问题或使用我们的聊天支持。我们必须提到这一点，因为 Spring 的配置通常消耗资源很大，我们必须为 Zipkin 相关任务尽可能节省资源。")]),e._v(" "),a("h2",{attrs:{id:"ui"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ui"}},[e._v("#")]),e._v(" UI")]),e._v(" "),a("p",[e._v("Zipkin 有一个 Web UI，自动包含在 exec jar 中，默认托管在端口 9411 上。")]),e._v(" "),a("p",[e._v("当 UI 加载时，它会从 "),a("code",[e._v("/config.json")]),e._v(" 端点读取默认配置。")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("属性")]),e._v(" "),a("th",[e._v("值")]),e._v(" "),a("th",[e._v("描述")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("environment")]),e._v(" "),a("td",[e._v("zipkin.ui.environment")]),e._v(" "),a("td",[e._v("这里的值变成右上角的标签。非必填")])]),e._v(" "),a("tr",[a("td",[e._v("defaultLookback")]),e._v(" "),a("td",[e._v("zipkin.ui.default-lookback")]),e._v(" "),a("td",[e._v("查找跟踪时回溯的默认持续时间（以毫秒为单位）。影响 UI 中的“开始时间”元素。默认为 900000（以毫秒为单位的 15 分钟）")])]),e._v(" "),a("tr",[a("td",[e._v("searchEnabled")]),e._v(" "),a("td",[e._v("zipkin.ui.search-enabled")]),e._v(" "),a("td",[e._v("如果启用了 Discover 屏幕。默认为真")])]),e._v(" "),a("tr",[a("td",[e._v("queryLimit")]),e._v(" "),a("td",[e._v("zipkin.ui.query-limit")]),e._v(" "),a("td",[e._v("查找 track 的默认限制。默认为 10")])]),e._v(" "),a("tr",[a("td",[e._v("instrumented")]),e._v(" "),a("td",[e._v("zipkin.ui.instrumented")]),e._v(" "),a("td",[e._v("此 Zipkin UI 涵盖哪些站点,正则表达式语法案例 "),a("code",[e._v("http:\\/\\/example.com\\/.*")]),e._v(" ，默认 ("),a("code",[e._v(".*")]),e._v(") 包含所有站点")])]),e._v(" "),a("tr",[a("td",[e._v("logsUrl")]),e._v(" "),a("td",[e._v("zipkin.ui.logs-url")]),e._v(" "),a("td",[e._v("记录查询服务 url 模式。如果指定，将在跟踪页面上显示一个按钮，并将 URL 中的 {traceId} 替换为 traceId。非必填")])]),e._v(" "),a("tr",[a("td",[e._v("supportUrl")]),e._v(" "),a("td",[e._v("zipkin.ui.support-url")]),e._v(" "),a("td",[e._v("用户可以请求支持的 URL。如果指定，将在侧面菜单中放置指向此 URL 的链接，例如用于提交支持票的页面。非必填")])]),e._v(" "),a("tr",[a("td",[e._v("archivePostUrl")]),e._v(" "),a("td",[e._v("zipkin.ui.archive-post-url")]),e._v(" "),a("td",[e._v("以 Zipkin v2 json 格式发布当前跟踪的 URL。例如 "),a("code",[e._v("https://longterm/api/v2/spans")]),e._v(" 。如果指定，一个按钮将相应地出现在跟踪页面上。非必填")])]),e._v(" "),a("tr",[a("td",[e._v("archiveUrl")]),e._v(" "),a("td",[e._v("zipkin.ui.archive-url")]),e._v(" "),a("td",[e._v("提供归档跟踪的 Web 应用程序的 URL，以“{traceId}”为模板。例如 "),a("code",[e._v("https://longterm/zipkin/trace/{traceId}")]),e._v(" 。跟踪成功发布到“archivePostUrl”后，确认消息中会显示此信息.非必填")])]),e._v(" "),a("tr",[a("td",[e._v("dependency.enabled")]),e._v(" "),a("td",[e._v("zipkin.ui.dependency.enabled")]),e._v(" "),a("td",[e._v("UI 依赖项展示是否启用. 默认为 true")])]),e._v(" "),a("tr",[a("td",[e._v("dependency.lowErrorRate")]),e._v(" "),a("td",[e._v("zipkin.ui.dependency.low-error-rate")]),e._v(" "),a("td",[e._v("依赖项链接变黄的错误率阈值。默认值为 0.5 (50%) 设置为 >1 以禁用")])]),e._v(" "),a("tr",[a("td",[e._v("dependency.highErrorRate")]),e._v(" "),a("td",[e._v("zipkin.ui.dependency.high-error-rate")]),e._v(" "),a("td",[e._v("依赖项链接变红的错误率阈值。默认值为 0.75 (75%) 设置为 >1 以禁用")])]),e._v(" "),a("tr",[a("td",[e._v("basePath")]),e._v(" "),a("td",[e._v("zipkin.ui.basepath")]),e._v(" "),a("td",[e._v("放置在 UI HTML 标签中的路径前缀；在反向代理后面运行时很有用。默认 "),a("code",[e._v("/zipkin")])])])])]),e._v(" "),a("p",[e._v("要将属性映射到环境变量，请将它们更改为大写下划线格式。例如，如果使用 docker，您可以设置 ZIPKIN_UI_QUERY_LIMIT=100 相当于 "),a("code",[e._v("$.queryLimit")]),e._v(" 在 "),a("code",[e._v("/config.json")])]),e._v(" "),a("h3",{attrs:{id:"跟踪存档"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#跟踪存档"}},[e._v("#")]),e._v(" 跟踪存档")]),e._v(" "),a("p",[e._v("大多数生产 Zipkin 集群使用有限的 TTL 存储跟踪。这使得共享跟踪有点不方便，因为它的链接将在几天后过期。")]),e._v(" "),a("p",[e._v('"跟踪归档" 功能对此有所帮助。启动第二个 zipkin 服务器，指向一个比常规的 TTL 更长的存储，并设置 archivePostUrl 和 archiveUrl UI 配置指向这第二个服务器。设置 archivePostUrl 后，跟踪视图页面上将出现一个新的 "Archive Trace" 按钮。')]),e._v(" "),a("h2",{attrs:{id:"存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存储"}},[e._v("#")]),e._v(" 存储")]),e._v(" "),a("h3",{attrs:{id:"基于内存存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基于内存存储"}},[e._v("#")]),e._v(" 基于内存存储")]),e._v(" "),a("p",[e._v("Zipkin 的 "),a("a",{attrs:{href:"../zipkin/src/main/java/zipkin2/storage/InMemoryStorage.java"}},[e._v("内存存储")]),e._v(" 将所有数据保存在内存中，根据跨度限制清除旧数据。它适用于 "),a("code",[e._v("STORAGE_TYPE")]),e._v(" 未设置或设置为 mem")]),e._v(" "),a("blockquote",[a("ul",[a("li",[a("code",[e._v("MEM_MAX_SPANS")]),e._v(": 超过此限制时，将首先清除最旧的记录道（及其跨度）。默认为 500000")])])]),e._v(" "),a("p",[e._v("示例用法：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("div",{staticClass:"custom-block danger"},[a("p",{staticClass:"custom-block-title"},[e._v("警告")]),e._v(" "),a("p",[e._v("注意：这个存储组件主要是为测试而开发的，也是一种在没有外部依赖的情况下快速启动和运行 Zipkin 服务器的方法。它对于高工作量是不可行的。也就是说，如果您遇到内存不足错误，请尝试减少 MEM_MAX_SPANS 或增加堆大小 (-Xmx)。 将内存中保存的跨度数量加倍的示例：")]),e._v(" "),a("p",[e._v("将内存中保存的跨度数量加倍的示例：")]),e._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("MEM_MAX_SPANS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1000000")]),e._v(" java -Xmx1G -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])])]),e._v(" "),a("h3",{attrs:{id:"cassandra-存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cassandra-存储"}},[e._v("#")]),e._v(" Cassandra 存储")]),e._v(" "),a("p",[e._v("Zipkin 的 Cassandra 存储组件支持 3.11.3+ 版本")]),e._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[e._v("Cassandra 相关配置")]),e._v(" "),a("p",[a("strong",[e._v("当 "),a("code",[e._v("STORAGE_TYPE")]),e._v(" 设置为 "),a("code",[e._v("cassandra3")]),e._v(" 时，以下配置生效：")])]),e._v(" "),a("p",[a("code",[e._v("CASSANDRA_KEYSPACE")]),e._v(': 要使用的键空间，默认为： "zipkin2"\n'),a("code",[e._v("CASSANDRA_CONTACT_POINTS")]),e._v(": 以逗号分隔的主机地址列表配置 Cassandra 集群。还可以使用 "),a("code",[e._v("host:port")]),e._v(" 指定自定义端口。默认为本地主机上的 9042 端口。\n"),a("code",[e._v("CASSANDRA_LOCAL_DC")]),e._v(": 将被视为负载平衡的 local 数据中心的名称。默认为 datacenter1\n"),a("code",[e._v("CASSANDRA_ENSURE_SCHEMA")]),e._v(": 确保 cassandra 使用最新模式。如果启用则尝试执行以 "),a("code",[e._v("cassandra-schema-cql3")]),e._v(" 的前缀的脚本. 默认为 true\n"),a("code",[e._v("CASSANDRA_USERNAME")]),e._v("：Cassandra 认证账号\n"),a("code",[e._v("CASSANDRA_PASSWORD")]),e._v(": Cassandra 认证密码，如果认真失败会抛出错误，未设置默认值。\n"),a("code",[e._v("CASSANDRA_USE_SSL")]),e._v(": 需要 "),a("code",[e._v("javax.net.ssl.trustStore")]),e._v(" 和 "),a("code",[e._v("javax.net.ssl.trustStorePassword")]),e._v(", 默认为 false.")]),e._v(" "),a("p",[a("strong",[e._v("以下是可能不涉及所有用户的调整参数：")])]),e._v(" "),a("ul",[a("li",[a("code",[e._v("CASSANDRA_MAX_CONNECTIONS")]),e._v(": 每个数据中心本地主机的最大池连接数。默认为8")]),e._v(" "),a("li",[a("code",[e._v("CASSANDRA_INDEX_CACHE_MAX")]),e._v(": 要缓存的最大跟踪索引元数据项。零禁用缓存。默认值为100000。")]),e._v(" "),a("li",[a("code",[e._v("CASSANDRA_INDEX_CACHE_TTL")]),e._v(": 缓存跟踪的索引元数据需要多少秒。默认值为60。")]),e._v(" "),a("li",[a("code",[e._v("CASSANDRA_INDEX_FETCH_MULTIPLIER")]),e._v(": 要获取的索引行比用户提供的查询限制多多少。默认为3。")])])]),e._v(" "),a("p",[e._v("使用 Cassandra 和请求日志记录的示例用法（TRACE 显示查询值）：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("STORAGE_TYPE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("cassandra3 java -jar zipkin.jar "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n--logging.level.com.datastax.oss.driver.internal.core.tracker.RequestLogger"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("DEBUG\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("h3",{attrs:{id:"elasticsearch-存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch-存储"}},[e._v("#")]),e._v(" Elasticsearch 存储")]),e._v(" "),a("p",[e._v("Zipkin 的 Elasticsearch 存储组件支持 5-7.x 版本")]),e._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[e._v("Elasticsearch 相关配置")]),e._v(" "),a("h2",{attrs:{id:"当-storage-type-设置为-elasticsearch-时-以下配置生效"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#当-storage-type-设置为-elasticsearch-时-以下配置生效"}},[e._v("#")]),e._v(" "),a("strong",[e._v("当 "),a("code",[e._v("STORAGE_TYPE")]),e._v(" 设置为 "),a("code",[e._v("elasticsearch")]),e._v(" 时，以下配置生效：")])]),e._v(" "),a("ul",[a("li",[a("code",[e._v("ES_HOSTS")]),e._v(': 以逗号分隔的 elasticsearch 连接 url 列表，默认值为： "http://localhost:9200"')]),e._v(" "),a("li",[a("code",[e._v("ES_PIPELINE")]),e._v(": 指示为跨距编制索引之前使用的摄取管道，无默认值")]),e._v(" "),a("li",[a("code",[e._v("ES_TIMEOUT")]),e._v(": 配置 Elasticsearch API 的连接、读写超时时间，默认值为 10000 (10秒)")]),e._v(" "),a("li",[a("code",[e._v("ES_INDEX")]),e._v(": 生成每日索引名称时要使用的索引前缀，默认值为： zipkin.")]),e._v(" "),a("li",[a("code",[e._v("ES_DATE_SEPARATOR")]),e._v(": 生成每日索引名称时要使用的日期分隔符，默认值为： '-' .")]),e._v(" "),a("li",[a("code",[e._v("ES_INDEX_SHARDS")]),e._v(": 索引分片数。每个碎片及其副本分配给群集中的一台机器。增加碎片的数量集群中的机器将提高读写性能。无法更改现有索引的碎片数量，但可以更改新的每日索引。默认为 5")]),e._v(" "),a("li",[a("code",[e._v("ES_INDEX_REPLICAS")]),e._v(": 索引碎片副本数。相对条件下数值越大读性能越好，写性能越差。默认值为 1 。设置为 0 意味着机器故障很大可能会导致数据丢失。")]),e._v(" "),a("li",[a("code",[e._v("ES_ENSURE_TEMPLATES")]),e._v(": 缺失时安装Zipkin索引模板。将此设置为 false ，当索引模板与预期不匹配时，会导致数据损坏。如果如果将其设置为 true ，则会自动处理数据故障或迁移问题，而不是依靠人工手动来解决。默认为true")]),e._v(" "),a("li",[a("code",[e._v("ES_USERNAME")]),e._v(" and "),a("code",[e._v("ES_PASSWORD")]),e._v(": Elasticsearch基本身份验证，默认为空字符串。当X-Pack安全（以前称为Shield）就位时使用。")]),e._v(" "),a("li",[a("code",[e._v("ES_CREDENTIALS_FILE")]),e._v(": ES 认证凭据文件位置, 包含以下属性，该文件优先级大于 ES_USERNAME 与 ES_PASSWORD 配置\n"),a("ul",[a("li",[a("code",[e._v("zipkin.storage.elasticsearch.username")]),e._v("：用户名")]),e._v(" "),a("li",[a("code",[e._v("zipkin.storage.elasticsearch.password")]),e._v("：密码")])])]),e._v(" "),a("li",[a("code",[e._v("ES_CREDENTIALS_REFRESH_INTERVAL")]),e._v(": 定期刷新 "),a("code",[e._v("ES_CREDENTIALS_FILE")]),e._v(" 文件周期（单位：秒），默认值为：1")]),e._v(" "),a("li",[a("code",[e._v("ES_HTTP_LOGGING")]),e._v(": 设置后，配置 Elasticsearch API 的 HTTP 日志记录，包含：Options are BASIC, HEADERS, BODY")]),e._v(" "),a("li",[a("code",[e._v("ES_SSL_NO_VERIFY")]),e._v(": 如果为true，则禁用服务器密钥证书链的验证。这不适合生产。默认为false。")]),e._v(" "),a("li",[a("code",[e._v("ES_TEMPLATE_PRIORITY")]),e._v(": 可组合索引模板的优先级值。这仅适用于ES 7.8或更高版本。必须设置为0才能使用可组合模板")])])]),e._v(" "),a("p",[e._v("使用示例：")]),e._v(" "),a("p",[e._v("简单连接 ES :")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("STORAGE_TYPE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("elasticsearch "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ES_HOSTS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("http://myhost:9200 java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("记录 ES http 请求日志:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("STORAGE_TYPE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("elasticsearch "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ES_HTTP_LOGGING")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("BASIC java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h4",{attrs:{id:"使用自定义密钥库或信任库-ssl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用自定义密钥库或信任库-ssl"}},[e._v("#")]),e._v(" 使用自定义密钥库或信任库 (SSL)")]),e._v(" "),a("p",[e._v("如果您的 Elasticsearch 端点自定义 SSL 配置（例如自签名）证书，您可以使用以下任何 "),a("a",{attrs:{href:"https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html#T6",target:"_blank",rel:"noopener noreferrer"}},[e._v("JSSE 属性子集"),a("OutboundLink")],1),e._v(" 连接。")]),e._v(" "),a("ul",[a("li",[e._v("javax.net.ssl.keyStore")]),e._v(" "),a("li",[e._v("javax.net.ssl.keyStorePassword")]),e._v(" "),a("li",[e._v("javax.net.ssl.keyStoreType")]),e._v(" "),a("li",[e._v("javax.net.ssl.trustStore")]),e._v(" "),a("li",[e._v("javax.net.ssl.trustStorePassword")]),e._v(" "),a("li",[e._v("javax.net.ssl.trustStoreType")])]),e._v(" "),a("p",[e._v("使用示例：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("JAVA_OPTS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'-Djavax.net.ssl.keyStore=keystore.p12 -Djavax.net.ssl.keyStorePassword=keypassword -Djavax.net.ssl.keyStoreType=PKCS12 -Djavax.net.ssl.trustStore=truststore.p12 -Djavax.net.ssl.trustStorePassword=trustpassword -Djavax.net.ssl.trustStoreType=PKCS12'")]),e._v("\n$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("STORAGE_TYPE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("elasticsearch java "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$JAVA_OPTS")]),e._v(" -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("在该场景下，这些映射到属性 "),a("code",[e._v("prefixed zipkin.storage.elasticsearch.ssl.")]),e._v("，这会影响用于连接到 Elasticsearch 的 Armeria 客户端。")]),e._v(" "),a("p",[e._v("上述属性允许最常见的 SSL 开箱即用的设置。如果您需要更多定制，请提交 "),a("a",{attrs:{href:"https://github.com/openzipkin/zipkin/issues/2774",target:"_blank",rel:"noopener noreferrer"}},[e._v("issue"),a("OutboundLink")],1)]),e._v(" "),a("h4",{attrs:{id:"自动创建索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自动创建索引"}},[e._v("#")]),e._v(" 自动创建索引")]),e._v(" "),a("p",[e._v("当需要的时候 Zipkin 自动创建 ES 索引。 Elasticsearch 默认 "),a("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#index-creation",target:"_blank",rel:"noopener noreferrer"}},[e._v("允许"),a("OutboundLink")],1),e._v(" 自动创建索引, 你可以在集群中验证这个设置: "),a("code",[e._v("action.auto_create_index: false")]),e._v(".")]),e._v(" "),a("h4",{attrs:{id:"mysql-存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-存储"}},[e._v("#")]),e._v(" MySQL 存储")]),e._v(" "),a("p",[e._v("Zipkin 的 MySQL 存储组件支持 5.7 版本\n当 "),a("code",[e._v("STORAGE_TYPE")]),e._v(" 设置为 "),a("code",[e._v("mysql")]),e._v(" 时，以下属性生效：")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("MYSQL_DB")]),e._v(': MySQL 使用数据库，默认为 "zipkin".')]),e._v(" "),a("li",[a("code",[e._v("MYSQL_USER")]),e._v(" and "),a("code",[e._v("MYSQL_PASS")]),e._v(": MySQL 认证信息, 默认值为空.")]),e._v(" "),a("li",[a("code",[e._v("MYSQL_HOST")]),e._v(": 默认值为 localhost")]),e._v(" "),a("li",[a("code",[e._v("MYSQL_TCP_PORT")]),e._v(": 默认值为 3306")]),e._v(" "),a("li",[a("code",[e._v("MYSQL_MAX_CONNECTIONS")]),e._v(":  MySQL 最大连接数, defaults to 10")]),e._v(" "),a("li",[a("code",[e._v("MYSQL_USE_SSL")]),e._v(": 需要 "),a("code",[e._v("javax.net.ssl.trustStore")]),e._v(" and "),a("code",[e._v("javax.net.ssl.trustStorePassword")]),e._v(", 默认为 false.")])]),e._v(" "),a("p",[e._v("注意：不建议将此模块用于生产用途。使用前，需要进行以下环境配置：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Barracuda supports compression (In AWS RDS, this must be assigned in a parameter group)")]),e._v("\n$ mysql -uroot -e "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"SET GLOBAL innodb_file_format=Barracuda"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v('# This command should work even in RDS, and return "Barracuda"')]),e._v("\n$ mysql -uroot -e "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("\"show global variables like 'innodb_file_format'\"")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# install the schema and indexes")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# sql 文件获取：https://github.com/openzipkin/zipkin/blob/master/zipkin-storage/mysql-v1/src/main/resources/mysql.sql")]),e._v("\n$ mysql -uroot -e "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"create database if not exists zipkin"')]),e._v("\n$ mysql -uroot -Dzipkin "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v(" zipkin-storage/mysql-v1/src/main/resources/mysql.sql\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br"),a("span",{staticClass:"line-number"},[e._v("9")]),a("br")])]),a("p",[e._v("或者，您可以 "),a("code",[e._v("MYSQL_JDBC_URL")]),e._v(" 自己使用并指定完整的 JDBC url。请注意，使用上述单独设置构建的 URL 还将包含以下参数： "),a("code",[e._v("?autoReconnect=true&useSSL=false&useUnicode=yes&characterEncoding=UTF-8")]),e._v("。")]),e._v(" "),a("p",[e._v("示例用法：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("STORAGE_TYPE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("mysql "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("MYSQL_USER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("root java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h3",{attrs:{id:"throttled-存储-实验性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#throttled-存储-实验性"}},[e._v("#")]),e._v(" Throttled 存储 (实验性)")]),e._v(" "),a("p",[e._v("这些设置可用于帮助调整 Zipkin 将数据刷新到另一个底层 "),a("code",[e._v("StorageComponent")]),e._v(" （例如 Elasticsearch）的速率：")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("STORAGE_THROTTLE_ENABLED")]),e._v(": Enables throttling")]),e._v(" "),a("li",[a("code",[e._v("STORAGE_THROTTLE_MIN_CONCURRENCY")]),e._v(": Minimum number of Threads to use for writing to storage.")]),e._v(" "),a("li",[a("code",[e._v("STORAGE_THROTTLE_MAX_CONCURRENCY")]),e._v(": Maximum number of Threads to use for writing to storage.")]),e._v(" "),a("li",[a("code",[e._v("STORAGE_THROTTLE_MAX_QUEUE_SIZE")]),e._v(": How many messages to buffer while all Threads are writing data before abandoning a message (0 = no buffering).")])]),e._v(" "),a("p",[e._v("由于此功能是实验性的，因此不建议在生产环境中运行此功能。")]),e._v(" "),a("h2",{attrs:{id:"收集器-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#收集器-2"}},[e._v("#")]),e._v(" 收集器")]),e._v(" "),a("h3",{attrs:{id:"http-收集器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-收集器"}},[e._v("#")]),e._v(" HTTP 收集器")]),e._v(" "),a("p",[e._v("HTTP 收集器默认启用。 他支持 "),a("code",[e._v("POST /api/v1/spans")]),e._v(" and "),a("code",[e._v("POST /api/v2/spans")]),e._v(".\nHTTP 收集器默支持以下配置:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("环境变量")]),e._v(" "),a("th",[e._v("属性")]),e._v(" "),a("th",[e._v("描述")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("code",[e._v("COLLECTOR_HTTP_ENABLED")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.http.enabled")])]),e._v(" "),a("td",[a("code",[e._v("false")]),e._v(" 禁用 HTTP 收集器。默认为 "),a("code",[e._v("true")])])])])]),e._v(" "),a("h3",{attrs:{id:"scribe-legacy-collector"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#scribe-legacy-collector"}},[e._v("#")]),e._v(" Scribe (Legacy) Collector")]),e._v(" "),a("p",[e._v("支持 Scribe 的收集器在 "),a("code",[e._v("COLLECTOR_SCRIBE_ENABLED=true")]),e._v(" 时启用. 不鼓励新站点使用此收集器，因为 Scribe 是一种存档技术。")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("环境变量")]),e._v(" "),a("th",[e._v("属性")]),e._v(" "),a("th",[e._v("描述")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("code",[e._v("COLLECTOR_PORT")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.scribe.port")])]),e._v(" "),a("td",[e._v("监听 thrift RPC scribe 请求的端口。默认为 9410")])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("SCRIBE_CATEGORY")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.scribe.category")])]),e._v(" "),a("td",[e._v("类别 zipkin 将从中消耗。默认为 "),a("code",[e._v("zipkin")])])])])]),e._v(" "),a("h3",{attrs:{id:"activemq-收集器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#activemq-收集器"}},[e._v("#")]),e._v(" ActiveMQ 收集器")]),e._v(" "),a("p",[e._v("Zipkin 的 ActiveMQ 收集器组件支持 v5.x 版本，当配置 "),a("code",[e._v("ACTIVEMQ_URL")]),e._v(" 值时启用，支持以下属性配置")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("环境变量")]),e._v(" "),a("th",[e._v("属性")]),e._v(" "),a("th",[e._v("描述")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("code",[e._v("COLLECTOR_ACTIVEMQ_ENABLED")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.enabled")])]),e._v(" "),a("td",[a("code",[e._v("false")]),e._v(" 禁用 ActiveMQ 收集器。默认为 "),a("code",[e._v("true")]),e._v(".")])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_URL")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.url")])]),e._v(" "),a("td",[a("a",{attrs:{href:"https://activemq.apache.org/uri-protocols",target:"_blank",rel:"noopener noreferrer"}},[e._v("Connection URL"),a("OutboundLink")],1),e._v(" 连接设置, 例如 "),a("code",[e._v("tcp://localhost:61616")]),e._v(" 或 "),a("code",[e._v("failover:(tcp://localhost:61616,tcp://remotehost:61616)")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_QUEUE")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.queue")])]),e._v(" "),a("td",[e._v("从中收集消息的队列名称。 默认为 "),a("code",[e._v("zipkin")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_CLIENT_ID_PREFIX")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.client-id-prefix")])]),e._v(" "),a("td",[e._v("队列使用者的客户端ID前缀。默认为 "),a("code",[e._v("zipkin")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_CONCURRENCY")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.concurrency")])]),e._v(" "),a("td",[e._v("并发消费数量。 默认为 "),a("code",[e._v("1")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_USERNAME")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.username")])]),e._v(" "),a("td",[e._v("ActiveMQ 连接用户名")])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("ACTIVEMQ_PASSWORD")])]),e._v(" "),a("td",[a("code",[e._v("zipkin.collector.activemq.password")])]),e._v(" "),a("td",[e._v("ActiveMQ 连接密码")])])])]),e._v(" "),a("p",[e._v("示例用法：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ACTIVEMQ_URL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("tcp://localhost:61616 java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h3",{attrs:{id:"kafka-收集器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#kafka-收集器"}},[e._v("#")]),e._v(" Kafka 收集器")]),e._v(" "),a("p",[e._v("Zipkin 的 Kafka 收集器组件支持 v0.10+ 版本，当配置 "),a("code",[e._v("KAFKA_BOOTSTRAP_SERVERS")]),e._v(" 值时启用，支持以下属性配置")]),e._v(" "),a("p",[e._v("关于 kafka 的新消费者配置请看 "),a("a",{attrs:{href:"https://kafka.apache.org/documentation/#newconsumerconfigs",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("变量")]),e._v(" "),a("th",[e._v("New Consumer Config")]),e._v(" "),a("th",[e._v("描述")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("code",[e._v("COLLECTOR_KAFKA_ENABLED")])]),e._v(" "),a("td",[e._v("N/A")]),e._v(" "),a("td",[a("code",[e._v("false")]),e._v(" 禁用 Kafka 收集器。默认为 "),a("code",[e._v("true")]),e._v(".")])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("KAFKA_BOOTSTRAP_SERVERS")])]),e._v(" "),a("td",[e._v("bootstrap.servers")]),e._v(" "),a("td",[e._v("以逗号分隔的连接配置列表, 例如： 127.0.0.1:9092。无默认值")])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("KAFKA_GROUP_ID")])]),e._v(" "),a("td",[e._v("group.id")]),e._v(" "),a("td",[e._v("此进程所代表的消费组。默认为 "),a("code",[e._v("zipkin")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("KAFKA_TOPIC")])]),e._v(" "),a("td",[e._v("N/A")]),e._v(" "),a("td",[e._v("kafka 消费者 topic 配置。默认为 "),a("code",[e._v("zipkin")])])]),e._v(" "),a("tr",[a("td",[a("code",[e._v("KAFKA_STREAMS")])]),e._v(" "),a("td",[e._v("N/A")]),e._v(" "),a("td",[e._v("topic 消费线程数。默认为  "),a("code",[e._v("1")])])])])]),e._v(" "),a("p",[e._v("示例用法：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KAFKA_BOOTSTRAP_SERVERS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),e._v(".0.1:9092 java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h4",{attrs:{id:"其他的-kafka-消费者属性配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他的-kafka-消费者属性配置"}},[e._v("#")]),e._v(" 其他的 kafka 消费者属性配置")]),e._v(" "),a("p",[e._v("您可能需要设置其他 "),a("a",{attrs:{href:"https://kafka.apache.org/documentation/#newconsumerconfigs",target:"_blank",rel:"noopener noreferrer"}},[e._v("Kafka 消费者属性"),a("OutboundLink")],1),e._v("，除了由收集器定义的具有显式属性的那些。在这种情况下，您需要在该属性名称前面加上前缀 "),a("code",[e._v("zipkin.collector.kafka.overrides")]),e._v(" 并将其作为系统属性参数传递。\n例如，要覆盖 "),a("code",[e._v("auto.offset.reset")]),e._v(" 属性, 你需要设置一个名为 "),a("code",[e._v("zipkin.collector.kafka.overrides.auto.offset.reset")]),e._v(" 的属性:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KAFKA_BOOTSTRAP_SERVERS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),e._v(".0.1:9092 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    java -Dzipkin.collector.kafka.overrides.auto.offset.reset"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("latest -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("h4",{attrs:{id:"详细示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#详细示例"}},[e._v("#")]),e._v(" 详细示例")]),e._v(" "),a("p",[e._v("针对在 Docker 中运行的 Kafka 的示例：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KAFKA_BOOTSTRAP_SERVERS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),e._v("docker-machine "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("ip")]),e._v(" `docker-machine active`"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 后台运行 kafka")]),e._v("\n$ docker run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("9092")]),e._v(":9092 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    --env "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("ADVERTISED_HOST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$KAFKA_BOOTSTRAP_SERVERS")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    --env "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("AUTO_CREATE_TOPICS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("true "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    spotify/kafka\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 通过 $KAFKA_BOOTSTRAP_SERVERS 环境变脸启动 zipkin 服务")]),e._v("\n$ java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br")])]),a("p",[e._v("多个 bootstrap servers 配置:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KAFKA_BOOTSTRAP_SERVERS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("broker1.local:9092,broker2.local:9092 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("备用 topic 名称配置:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("KAFKA_BOOTSTRAP_SERVERS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),e._v(".0.1:9092 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    java -Dzipkin.collector.kafka.topic"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("zapkin,zipken -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("将 bootstrap servers 指定为系统属性，而不是环境变量:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ java -Dzipkin.collector.kafka.bootstrap-servers"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),e._v(".0.1:9092 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n    -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("h3",{attrs:{id:"rabbitmq-收集器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rabbitmq-收集器"}},[e._v("#")]),e._v(" RabbitMQ 收集器")]),e._v(" "),a("p",[e._v("当设置 "),a("code",[e._v("addresses")]),e._v(" 或 "),a("code",[e._v("uri")]),e._v(" 的时候， "),a("a",{attrs:{href:"../zipkin-collector/rabbitmq"}},[e._v("RabbitMQ 收集器")]),e._v(" 会启动")]),e._v(" "),a("p",[e._v("示例用法：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("RABBIT_ADDRESSES")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("localhost java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h3",{attrs:{id:"grpc-收集器-实验性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#grpc-收集器-实验性"}},[e._v("#")]),e._v(" gRPC 收集器 (实验性)")]),e._v(" "),a("p",[e._v("您可以通过设置 "),a("code",[e._v("COLLECTOR_GRPC_ENABLED=true")]),e._v(" 启用 gRPC 收集器端点。 "),a("code",[e._v("zipkin.proto3.SpanService/Report")]),e._v(" 端点会和普通 http 服务一样运行。")]),e._v(" "),a("p",[e._v("示例用法：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("COLLECTOR_GRPC_ENABLED")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("true java -jar zipkin.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("由于此服务是实验性的，因此不建议在生产环境中运行此服务。")]),e._v(" "),a("h2",{attrs:{id:"自我追踪"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自我追踪"}},[e._v("#")]),e._v(" 自我追踪")]),e._v(" "),a("p",[e._v("存在自我跟踪以帮助解决 zipkin 服务器的性能问题。在生产部署应该将自我跟踪的应将采样率从 1.0 (100%) 降低到更小的速率，例如 0.001（0.1% 或千分之一）。")]),e._v(" "),a("p",[e._v("当配置 "),a("code",[e._v("zipkin.self-tracing.enabled=true")]),e._v(', Zipkin 将自动启动对服务 "zipkin-server" 的 API 的调用进行自我追踪')]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("变量")]),e._v(" "),a("th",[e._v("属性")]),e._v(" "),a("th",[e._v("描述")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("SELF_TRACING_ENABLED")]),e._v(" "),a("td",[e._v("zipkin.self-tracing.enabled")]),e._v(" "),a("td",[e._v("设置为 true 以启用自我跟踪。默认为 false")])]),e._v(" "),a("tr",[a("td",[e._v("SELF_TRACING_SAMPLE_RATE")]),e._v(" "),a("td",[e._v("zipkin.self-tracing.sample-rate")]),e._v(" "),a("td",[e._v("要保留的自我跟踪的百分比，默认为始终采样 (1.0)。")])]),e._v(" "),a("tr",[a("td",[e._v("SELF_TRACING_FLUSH_INTERVAL")]),e._v(" "),a("td",[e._v("zipkin.self-tracing.flush-interval")]),e._v(" "),a("td",[e._v("将自跟踪数据刷新到存储的时间间隔（以秒为单位）。默认为 1")])])])]),e._v(" "),a("h3",{attrs:{id:"_128-位跟踪-id"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_128-位跟踪-id"}},[e._v("#")]),e._v(" 128 位跟踪 ID")]),e._v(" "),a("p",[e._v("Zipkin 支持 64 位和 128 位跟踪标识符，通常序列化为 16 或 32 个字符的十六进制字符串。默认情况下，向 zipkin 报告的具有相同跟踪 ID 的跨度将被考虑在同一跟踪中。")]),e._v(" "),a("p",[e._v("例如， "),a("code",[e._v("463ac35c9f6413ad48485a3953bb6124")]),e._v(" 是 128 位的跟踪 ID，而 "),a("code",[e._v("48485a3953bb6124")]),e._v(" 是 64 位的。")]),e._v(" "),a("p",[e._v("注意：跟踪中的跨度（或父）ID 是 64 位的，无论其跟踪 ID 的长度或值如何")]),e._v(" "),a("h4",{attrs:{id:"从-64-位迁移到-128-位跟踪-id"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从-64-位迁移到-128-位跟踪-id"}},[e._v("#")]),e._v(" 从 64 位迁移到 128 位跟踪 ID")]),e._v(" "),a("p",[e._v("除非您在所有应用程序都支持时仅发出 128 位跟踪，否则将应用程序从 64 位跟踪 ID 更新到 128 位跟踪 ID 的过程会导致混合状态。这种混合状态通过设置 "),a("code",[e._v("STRICT_TRACE_ID=false")]),e._v(" 来缓解。如下所述，迁移完成后，删除 "),a("code",[e._v("STRICT_TRACE_ID=false")]),e._v(" 设置，或者将其设置为 true")]),e._v(" "),a("p",[e._v("以下是一些跟踪ID，它们可以帮助您了解此设置过程中发生的情况。")]),e._v(" "),a("ul",[a("li",[e._v("Trace ID A: 463ac35c9f6413ad48485a3953bb6124")]),e._v(" "),a("li",[e._v("Trace ID B: 48485a3953bb6124")]),e._v(" "),a("li",[e._v("Trace ID C: 463ac35c9f6413adf1a48a8cff464e0e")]),e._v(" "),a("li",[e._v("Trace ID D: 463ac35c9f6413ad")])]),e._v(" "),a("p",[e._v("在 64 位环境中，跟踪 ID 看起来像上面的 B 或 D。当应用程序升级到 128 位检测并决定创建 128 位跟踪时，其跟踪 ID 将类似于上面的 A 或 C。")]),e._v(" "),a("p",[e._v("尚不支持 128 位的应用程序通常只保留跟踪 ID 最右边的 16 个字符。发生这种情况时，同一跟踪可能会报告为跟踪 ID A 或跟踪 ID B。")]),e._v(" "),a("p",[e._v("默认情况下，Zipkin 会认为这些是不同的跟踪 ID，因为它们是不同的字符串。在从 64 位到 128 位跟踪 ID 的转换过程中，跨度将出现在两个 ID 之间。例如，它可能以跟踪 ID A 开始，但下一跃点可能会将其截断为跟踪 ID B。这会使系统无法用于执行升级的应用程序。")]),e._v(" "),a("p",[e._v("解决此问题的一种方法是在所有应用程序都支持之前不使用 128 位跟踪 ID。这以协调为代价防止了混合情况。另一种方法是设置 "),a("code",[e._v("STRICT_TRACE_ID=false")])]),e._v(" "),a("p",[e._v("当设置 "),a("code",[e._v("STRICT_TRACE_ID=false")]),e._v(" ，在对跟踪进行分组或检索时，只考虑 32 个字符的跟踪 ID 中最右边的 16 个。此设置应仅在从 64 位跟踪 ID 转换到 128 位跟踪 ID 时应用，并在转换完成后删除。")]),e._v(" "),a("p",[e._v("请查看 "),a("a",{attrs:{href:"https://github.com/openzipkin/b3-propagation/issues/6",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://github.com/openzipkin/b3-propagation/issues/6"),a("OutboundLink")],1),e._v(" 了解 128 位跟踪标识符上已知开源库的状态。")]),e._v(" "),a("p",[e._v("查看源码 "),a("code",[e._v("zipkin2.storage.StorageComponent.Builder")]),e._v(" 了解更多信息")]),e._v(" "),a("h2",{attrs:{id:"tls-ssl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tls-ssl"}},[e._v("#")]),e._v(" TLS/SSL")]),e._v(" "),a("p",[e._v("如果需要，可以使 Zipkin-server 与 TLS 一起运行：")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# assuming you generate the key like this")]),e._v("\nkeytool -genkeypair -alias mysite -keyalg RSA -keysize "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2048")]),e._v(" -storetype PKCS12 -keystore zipkin.p12 -validity "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3650")]),e._v("\n\njava -jar zipkin.jar --armeria.ssl.key-store"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("zipkin.p12 --armeria.ssl.key-store-type"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("PKCS12 --armeria.ssl.key-store-password"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("123123")]),e._v(" --armeria.ssl.key-alias"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("mysite  --armeria.ssl.enabled"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("true --armeria.ports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(".port"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("9411")]),e._v(" --armeria.ports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(".protocols"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("https\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("h2",{attrs:{id:"运行在-docker-中"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#运行在-docker-中"}},[e._v("#")]),e._v(" 运行在 Docker 中")]),e._v(" "),a("p",[e._v("zipkin-server 的发布版本以 "),a("code",[e._v("openzipkin/zipkin")]),e._v(" 发布在 "),a("a",{attrs:{href:"https://hub.docker.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Docker Hub"),a("OutboundLink")],1),e._v(" 。点击 "),a("a",{attrs:{href:"https://github.com/openzipkin/docker-zipkin",target:"_blank",rel:"noopener noreferrer"}},[e._v("docker-zipkin"),a("OutboundLink")],1),e._v(" 查看详情")]),e._v(" "),a("h2",{attrs:{id:"本地构建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#本地构建"}},[e._v("#")]),e._v(" 本地构建")]),e._v(" "),a("p",[e._v("要从源码构建和运行服务器，请输入以下内容")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Build the server and also make its dependencies")]),e._v("\n$ ./mvnw -T1C -q --batch-mode -DskipTests --also-make -pl zipkin-server clean package\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Run the server")]),e._v("\n$ java -jar ./zipkin-server/target/zipkin-server-*exec.jar\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# or Run the slim server")]),e._v("\n$ java -jar ./zipkin-server/target/zipkin-server-*slim.jar\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br")])])])}),[],!1,null,null,null);t.default=r.exports}}]);