(window.webpackJsonp=window.webpackJsonp||[]).push([[103],{1111:function(a,s,t){"use strict";t.r(s);var n=t(1),e=Object(n.a)({},(function(){var a=this,s=a.$createElement,n=a._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[n("h2",{attrs:{id:"场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#场景"}},[a._v("#")]),a._v(" 场景")]),a._v(" "),n("p",[a._v("处理慢接口，定位Spring Cloud 服务间调用，确定各个链路执行时间")]),a._v(" "),n("h3",{attrs:{id:"涉及所有软件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#涉及所有软件"}},[a._v("#")]),a._v(" 涉及所有软件")]),a._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://gitee.com/jdw-silky/silky-parent.git",target:"_blank",rel:"noopener noreferrer"}},[a._v("微服务项目地址"),n("OutboundLink")],1)]),a._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/openzipkin/zipkin.git",target:"_blank",rel:"noopener noreferrer"}},[a._v("zipkin 源码地址"),n("OutboundLink")],1)]),a._v(" "),n("li",[n("a",{attrs:{href:"https://kafka.apache.org/downloads",target:"_blank",rel:"noopener noreferrer"}},[a._v("kafka"),n("OutboundLink")],1)]),a._v(" "),n("li",[n("a",{attrs:{href:"https://www.elastic.co/cn/elasticsearch/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Elastic search"),n("OutboundLink")],1)]),a._v(" "),n("li",[n("a",{attrs:{href:"https://www.elastic.co/cn/kibana/",target:"_blank",rel:"noopener noreferrer"}},[a._v("kibana"),n("OutboundLink")],1)])]),a._v(" "),n("h3",{attrs:{id:"环境准备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#环境准备"}},[a._v("#")]),a._v(" 环境准备")]),a._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://jdk.java.net/17/",target:"_blank",rel:"noopener noreferrer"}},[a._v("jdk17"),n("OutboundLink")],1)]),a._v(" "),n("li",[n("a",{attrs:{href:"https://maven.apache.org/",target:"_blank",rel:"noopener noreferrer"}},[a._v("maven"),n("OutboundLink")],1)]),a._v(" "),n("li",[n("a",{attrs:{href:"https://www.jetbrains.com/idea/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Intellij IDEA"),n("OutboundLink")],1)])]),a._v(" "),n("h2",{attrs:{id:"实现效果"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实现效果"}},[a._v("#")]),a._v(" 实现效果")]),a._v(" "),n("p",[a._v("微服务之间调用链路耗时，能在 zipkin 看到，并且能看区分长请求。链路数据入 Elastic Search 库。")]),a._v(" "),n("h3",{attrs:{id:"安装-es、kafka"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装-es、kafka"}},[a._v("#")]),a._v(" 安装 ES、kafka")]),a._v(" "),n("p",[a._v("docker 对于技术学习测试真的很方便")]),a._v(" "),n("ul",[n("li",[n("p",[n("a",{attrs:{href:"https://www.cnblogs.com/jiangdewen/p/15119574.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("ES 集群安装"),n("OutboundLink")],1)])]),a._v(" "),n("li",[n("p",[n("a",{attrs:{href:"https://www.cnblogs.com/jiangdewen/p/15118629.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("kibana 安装"),n("OutboundLink")],1)])]),a._v(" "),n("li",[n("p",[n("RouterLink",{attrs:{to:"/middleware/mq/kafka/quick-start.html"}},[a._v("kafka 安装")])],1)])]),a._v(" "),n("h3",{attrs:{id:"启动微服务项目"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#启动微服务项目"}},[a._v("#")]),a._v(" 启动微服务项目")]),a._v(" "),n("p",[a._v("提一句，微服务集成 zipkin 除了增加了两个引用与少量的环境配置，不改变任何代码。")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v("    implementation 'org.springframework.cloud:spring-cloud-sleuth-zipkin'\n    implementation 'org.springframework.cloud:spring-cloud-starter-sleuth'\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br")])]),n("div",{staticClass:"language-yml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spring")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("application")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" silky"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("demo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("web\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("zipkin")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("service")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" $"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("spring.application.name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("sender")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" kafka\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kafka")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("topic")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" zipkin\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kafka")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("bootstrap-servers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 192.168.137.165"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[a._v("9091")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("192.168.137.165"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[a._v("9092")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("192.168.137.165"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[a._v("9093")]),a._v("\n\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br"),n("span",{staticClass:"line-number"},[a._v("7")]),n("br"),n("span",{staticClass:"line-number"},[a._v("8")]),n("br"),n("span",{staticClass:"line-number"},[a._v("9")]),n("br"),n("span",{staticClass:"line-number"},[a._v("10")]),n("br"),n("span",{staticClass:"line-number"},[a._v("11")]),n("br"),n("span",{staticClass:"line-number"},[a._v("12")]),n("br"),n("span",{staticClass:"line-number"},[a._v("13")]),n("br")])]),n("h3",{attrs:{id:"启动-zipkin"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#启动-zipkin"}},[a._v("#")]),a._v(" 启动 zipkin")]),a._v(" "),n("p",[n("RouterLink",{attrs:{to:"/spring/track/zipkin/quick-start.html"}},[a._v("服务器启动方式")])],1),a._v(" "),n("h4",{attrs:{id:"以源码启动"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#以源码启动"}},[a._v("#")]),a._v(" 以源码启动")]),a._v(" "),n("p",[a._v("Intellij IDEA 以源码启动 zipkin 服务，主要难的是这个。此处需要配置 "),n("a",{attrs:{href:"https://www.cnblogs.com/jiangdewen/p/15928589.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("maven 跳过测试"),n("OutboundLink")],1),a._v("。")]),a._v(" "),n("p",[a._v("maven 跳过测试配置： "),n("code",[a._v("-Dmaven.test.skip=true")])]),a._v(" "),n("p",[n("img",{attrs:{src:t(699),alt:""}})]),a._v(" "),n("p",[n("img",{attrs:{src:t(700),alt:""}})]),a._v(" "),n("blockquote",[n("p",[a._v("由于 zipkin-lens 项目用到了 "),n("a",{attrs:{href:"https://react.docschina.org/",target:"_blank",rel:"noopener noreferrer"}},[a._v("react"),n("OutboundLink")],1),a._v(" 。如果该 zipkin-lens 打包出错，尝试配置 node 环境。")])]),a._v(" "),n("p",[n("strong",[a._v("配置文件修改")])]),a._v(" "),n("p",[a._v("修改项目启动配置文件 zipkin-server-shared.yml，之所以启动配置文件是这个，我们可以在启动类看到配置了 spring 启动参数 "),n("code",[a._v("spring.config.name=zipkin-server")]),a._v("。而 zipkin-server.yml 文件指定了 "),n("code",[a._v("spring.profiles.include: shared")])]),a._v(" "),n("p",[n("img",{attrs:{src:t(701),alt:""}})]),a._v(" "),n("div",{staticClass:"language-properties line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-properties"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 项目实际为 yml 文件，此处用 properties 文件格式展示是为了便于笔记展示")]),a._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置 kafka bootstrap servers")]),a._v("\n"),n("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("zipkin.collector.kafka.bootstrap-servers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[a._v("${KAFKA_BOOTSTRAP_SERVERS:192.168.137.165:9092}")]),a._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置 storage 类型")]),a._v("\n"),n("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("zipkin.storage.type")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[a._v("${STORAGE_TYPE:elasticsearch}")]),a._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 配置 es 集群 url")]),a._v("\n"),n("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("zipkin.storage.elasticsearch.hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[a._v("${ES_HOSTS:http://192.168.137.165:9201,http://192.168.137.165:9202,http://192.168.137.165:9203}")]),a._v("\n\n``\n\n"),n("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("**启动")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[a._v("zipkin 项目**")]),a._v("\n\n"),n("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("项目启动必须先进行")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[a._v("maven 打包才行。")]),a._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[a._v("![](../img/zipkin-idea-package.jpg)")]),a._v("\n\n"),n("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("运行")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[a._v("`zipkin.server.ZipkinServer#main` 启动项目")]),a._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[a._v("![](../img/zipkin-maven-run.png)")]),a._v("\n\n**启动微服务项目**\n\n便于测试可以写几个简单的脚本\n\n"),n("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("-")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[a._v("eureka-server.bat")]),a._v("\n```bash\n"),n("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("d")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n"),n("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("cd")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[a._v("D:\\ideaProject\\gitee\\jdw-silky\\silky-parent\\silky-eureka-server\\build\\libs")]),a._v("\n"),n("span",{pre:!0,attrs:{class:"token attr-name"}},[a._v("java")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[a._v("-jar silky-eureka-server-1.0.1.jar --spring.profiles.active=native")]),a._v("\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br"),n("span",{staticClass:"line-number"},[a._v("7")]),n("br"),n("span",{staticClass:"line-number"},[a._v("8")]),n("br"),n("span",{staticClass:"line-number"},[a._v("9")]),n("br"),n("span",{staticClass:"line-number"},[a._v("10")]),n("br"),n("span",{staticClass:"line-number"},[a._v("11")]),n("br"),n("span",{staticClass:"line-number"},[a._v("12")]),n("br"),n("span",{staticClass:"line-number"},[a._v("13")]),n("br"),n("span",{staticClass:"line-number"},[a._v("14")]),n("br"),n("span",{staticClass:"line-number"},[a._v("15")]),n("br"),n("span",{staticClass:"line-number"},[a._v("16")]),n("br"),n("span",{staticClass:"line-number"},[a._v("17")]),n("br"),n("span",{staticClass:"line-number"},[a._v("18")]),n("br"),n("span",{staticClass:"line-number"},[a._v("19")]),n("br"),n("span",{staticClass:"line-number"},[a._v("20")]),n("br"),n("span",{staticClass:"line-number"},[a._v("21")]),n("br"),n("span",{staticClass:"line-number"},[a._v("22")]),n("br"),n("span",{staticClass:"line-number"},[a._v("23")]),n("br"),n("span",{staticClass:"line-number"},[a._v("24")]),n("br"),n("span",{staticClass:"line-number"},[a._v("25")]),n("br"),n("span",{staticClass:"line-number"},[a._v("26")]),n("br"),n("span",{staticClass:"line-number"},[a._v("27")]),n("br"),n("span",{staticClass:"line-number"},[a._v("28")]),n("br"),n("span",{staticClass:"line-number"},[a._v("29")]),n("br")])]),n("ul",[n("li",[a._v("config-server.bat")])]),a._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[a._v("d:\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" D:"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("ideaProject"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("gitee"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("jdw-silky"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("silky-parent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("silky-config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("build"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("libs\njava -jar silky-config-1.0.1.jar --spring.profiles.active"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("native\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br")])]),n("ul",[n("li",[a._v("web-server.bat")])]),a._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[a._v("d:\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" D:"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("ideaProject"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("gitee"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("jdw-silky"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("silky-parent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("silky-demo-web"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("build"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("libs\njava -jar silky-demo-web-1.0.1.jar --spring.profiles.active"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("native\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br")])]),n("p",[a._v("由于 web-server 服务的启动端口配置为 0 ，所以直接多点击两下就启动了几个 web-server 服务。")]),a._v(" "),n("h4",{attrs:{id:"验证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证"}},[a._v("#")]),a._v(" 验证")]),a._v(" "),n("ol",[n("li",[a._v("调用一次 web 服务")])]),a._v(" "),n("p",[n("img",{attrs:{src:t(702),alt:""}})]),a._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[a._v("在 zipkin 界面查看调用链")])]),a._v(" "),n("p",[n("img",{attrs:{src:t(703),alt:""}})]),a._v(" "),n("ol",{attrs:{start:"3"}},[n("li",[a._v("使用 kibana 查找调用链记录")])]),a._v(" "),n("p",[n("img",{attrs:{src:t(704),alt:""}})]),a._v(" "),n("p",[a._v("可以看到，一个调用链在 zipkin 看到了，并且持久化到 Elastic Search 里面了")])])}),[],!1,null,null,null);s.default=e.exports},699:function(a,s,t){a.exports=t.p+"assets/img/maven-skip-test1.8d7bf8bb.png"},700:function(a,s,t){a.exports=t.p+"assets/img/maven-skip-test2.bb5a5317.png"},701:function(a,s,t){a.exports=t.p+"assets/img/zipkin-code1.1311374c.png"},702:function(a,s,t){a.exports=t.p+"assets/img/test1.76b08cb8.png"},703:function(a,s,t){a.exports=t.p+"assets/img/test2.7cf25fcd.png"},704:function(a,s,t){a.exports=t.p+"assets/img/test3.57b10697.png"}}]);